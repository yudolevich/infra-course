<!DOCTYPE html>
<html class="writer-html5" lang="ru" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Secret Management &mdash; документация infra-course </title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/copybutton.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
        <script src="_static/clipboard.min.js"></script>
        <script src="_static/copybutton.js"></script>
        <script src="_static/translations.js"></script>
        <script src="https://unpkg.com/mermaid@9.4.0/dist/mermaid.min.js"></script>
        <script>mermaid.initialize({startOnLoad:true});</script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Алфавитный указатель" href="genindex.html" />
    <link rel="search" title="Поиск" href="search.html" />
    <link rel="next" title="Vault" href="12_practice_vault.html" />
    <link rel="prev" title="Salt Beacons/Reactors and IaC" href="10_practice_saltstack_reactor.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            infra-course
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Поиск в документации" aria-label="Поиск в документации" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Меню навигации">
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="practice.html">Практика</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="01_practice_vagrant.html">Vagrant</a></li>
<li class="toctree-l2"><a class="reference internal" href="02_practice_vagrant.html">Vagrant Multi-Node</a></li>
<li class="toctree-l2"><a class="reference internal" href="03_practice_docker.html">Docker</a></li>
<li class="toctree-l2"><a class="reference internal" href="04_practice_docker_images.html">Docker Images</a></li>
<li class="toctree-l2"><a class="reference internal" href="05_practice_docker_volume_network.html">Docker Volume/Network</a></li>
<li class="toctree-l2"><a class="reference internal" href="06_practice_docker_compose.html">Docker Compose</a></li>
<li class="toctree-l2"><a class="reference internal" href="07_practice_ansible.html">Ansible</a></li>
<li class="toctree-l2"><a class="reference internal" href="08_practice_ansible_roles.html">Ansible Roles and Collections</a></li>
<li class="toctree-l2"><a class="reference internal" href="09_practice_saltstack.html">Salt</a></li>
<li class="toctree-l2"><a class="reference internal" href="10_practice_saltstack_reactor.html">Salt Beacons/Reactors and IaC</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Secret Management</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#vagrant">Vagrant</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ansible-vault">Ansible Vault</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#create">Create</a></li>
<li class="toctree-l4"><a class="reference internal" href="#view">View</a></li>
<li class="toctree-l4"><a class="reference internal" href="#edit">Edit</a></li>
<li class="toctree-l4"><a class="reference internal" href="#encrypt-decrypt">Encrypt/Decrypt</a></li>
<li class="toctree-l4"><a class="reference internal" href="#playbook">Playbook</a></li>
<li class="toctree-l4"><a class="reference internal" href="#encrypt-string">Encrypt string</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#age">Age</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#keygen">Keygen</a></li>
<li class="toctree-l4"><a class="reference internal" href="#encrypt">Encrypt</a></li>
<li class="toctree-l4"><a class="reference internal" href="#decrypt">Decrypt</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ssh-key">SSH Key</a></li>
<li class="toctree-l4"><a class="reference internal" href="#multiple-keys">Multiple keys</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#sops">Sops</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#gpg">GPG</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id1">Encrypt</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id2">Edit</a></li>
<li class="toctree-l4"><a class="reference internal" href="#set-extract">Set/Extract</a></li>
<li class="toctree-l4"><a class="reference internal" href="#exec-file-env">Exec File/Env</a></li>
<li class="toctree-l4"><a class="reference internal" href="#update-keys">Update keys</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="12_practice_vault.html">Vault</a></li>
<li class="toctree-l2"><a class="reference internal" href="13_practice_rabbit.html">RabbitMQ</a></li>
<li class="toctree-l2"><a class="reference internal" href="14_practice_rabbit_routing.html">RabbitMQ Routing</a></li>
<li class="toctree-l2"><a class="reference internal" href="15_practice_kafka.html">Apache Kafka</a></li>
<li class="toctree-l2"><a class="reference internal" href="16_practice_kafka_cluster.html">Apache Kafka Cluster</a></li>
<li class="toctree-l2"><a class="reference internal" href="17_practice_terraform.html">Terraform</a></li>
<li class="toctree-l2"><a class="reference internal" href="18_practice_terraform_ansible.html">Terraform + Ansible</a></li>
<li class="toctree-l2"><a class="reference internal" href="19_practice_gitlab.html">Gitlab CI</a></li>
<li class="toctree-l2"><a class="reference internal" href="20_practice_jenkins.html">Jenkins</a></li>
<li class="toctree-l2"><a class="reference internal" href="21_practice_prometheus.html">Prometheus</a></li>
<li class="toctree-l2"><a class="reference internal" href="22_practice_alertmanager.html">Alertmanager</a></li>
<li class="toctree-l2"><a class="reference internal" href="23_practice_elasticsearch.html">ELK Stack</a></li>
<li class="toctree-l2"><a class="reference internal" href="24_practice_elk_app_logs.html">ELK Log Visualization</a></li>
<li class="toctree-l2"><a class="reference internal" href="25_practice_jaeger.html">Jaeger</a></li>
<li class="toctree-l2"><a class="reference internal" href="26_practice_jaeger_e2e.html">Jaeger E2E</a></li>
<li class="toctree-l2"><a class="reference internal" href="27_practice_opentelemetry.html">Opentelemetry Collector</a></li>
<li class="toctree-l2"><a class="reference internal" href="28_practice_otel_instrumentation.html">Opentelemetry Instrumentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="29_practice_istio.html">Istio</a></li>
<li class="toctree-l2"><a class="reference internal" href="30_practice_istio_kiali.html">Kiali</a></li>
<li class="toctree-l2"><a class="reference internal" href="31_practice_argocd.html">ArgoCD</a></li>
<li class="toctree-l2"><a class="reference internal" href="32_practice_argocd_gitops.html">ArgoCD GitOps</a></li>
<li class="toctree-l2"><a class="reference internal" href="33_practice_final.html">Самостоятельная работа</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Меню навигации для мобильных устройств" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">infra-course</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Навигация по страницам">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="practice.html">Практика</a></li>
      <li class="breadcrumb-item active">Secret Management</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/11_practice_secrets.md.txt" rel="nofollow"> Просмотреть исходный код страницы</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="secret-management">
<h1>Secret Management<a class="headerlink" href="#secret-management" title="Permalink to this heading"></a></h1>
<p>В данном практическом занятии познакомимся с инструментами для локального
управления чувствительными данными(пароли, ключи, токены и т.д.).</p>
<section id="vagrant">
<h2>Vagrant<a class="headerlink" href="#vagrant" title="Permalink to this heading"></a></h2>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="o">|</span><span class="n">config</span><span class="o">|</span>
<span class="w">  </span><span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span><span class="w"> </span><span class="s2">&quot;node&quot;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="o">|</span><span class="n">c</span><span class="o">|</span>
<span class="w">    </span><span class="n">c</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ubuntu/lunar64&quot;</span>
<span class="w">    </span><span class="n">c</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;node&quot;</span>
<span class="w">    </span><span class="n">c</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span><span class="w"> </span><span class="s2">&quot;private_network&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">type</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;dhcp&quot;</span>
<span class="w">    </span><span class="n">c</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span><span class="w"> </span><span class="s2">&quot;shell&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">inline</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;&lt;-</span><span class="dl">SHELL</span>
<span class="sh">      apt-get update -q</span>
<span class="sh">      apt-get install -yq libnss-mdns ansible</span>
<span class="sh">      curl -L https://github.com/FiloSottile/age/releases/download/v1.1.1/age-v1.1.1-linux-amd64.tar.gz \</span>
<span class="sh">        | tar xvz --strip-components=1 -C /usr/local/bin age/age age/age-keygen</span>
<span class="sh">      curl -L https://github.com/getsops/sops/releases/download/v3.8.1/sops-v3.8.1.linux.amd64 \</span>
<span class="sh">        -o /usr/local/bin/sops &amp;&amp; chmod +x /usr/local/bin/sops</span>
<span class="dl">    SHELL</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</section>
<section id="ansible-vault">
<h2>Ansible Vault<a class="headerlink" href="#ansible-vault" title="Permalink to this heading"></a></h2>
<p>Различные стеки технологий часто имеют собственные инструменты для управления
секретами, в <a class="reference external" href="https://docs.ansible.com/ansible/latest/index.html">ansible</a> таким инструментом является <a class="reference external" href="https://docs.ansible.com/ansible/latest/vault_guide/index.html">ansible-vault</a>. Утилита
<code class="docutils literal notranslate"><span class="pre">ansible-vault</span></code> позволяет шифровать данные парольной фразой, так что при утечке
не будет возможности воспользоваться секретными данными.</p>
<section id="create">
<h3>Create<a class="headerlink" href="#create" title="Permalink to this heading"></a></h3>
<p>Для создания секрета можно воспользоваться подкомандой <code class="docutils literal notranslate"><span class="pre">create</span></code>, которая запросит
пароль для нового файла и откроет текстовый редактор, определенный в переменной
<code class="docutils literal notranslate"><span class="pre">EDITOR</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nv">EDITOR</span><span class="o">=</span>nano<span class="w"> </span>ansible-vault<span class="w"> </span>create<span class="w"> </span>secret.yaml
<span class="go">New Vault password:</span>
<span class="go">Confirm New Vault password:</span>
<span class="go">  /home/vagrant/.ansible/tmp/ansible-local-71380mr2u0wp/tmpfx3ulqj0.yaml *</span>
<span class="go">item: secret_data</span>
<span class="go">list:</span>
<span class="go">- secret_item1</span>
<span class="go">- secret_item2</span>
<span class="go">- secret_item3</span>
<span class="go">dict:</span>
<span class="go">  key1: secret_value</span>
<span class="go">  key2: secret_value</span>

<span class="go">^G Help      ^O Write Out ^W Where Is  ^K Cut       ^T Execute   ^C Location</span>
<span class="go">^X Exit      ^R Read File ^\ Replace   ^U Paste     ^J Justify   ^/ Go To Line</span>
</pre></div>
</div>
<p>Внесем данные, которые хотим зашифровать и сохраним файл.</p>
<p>Если на текущий момент посмотреть данный файл, то содержимое будет в зашифрованном
виде:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>cat<span class="w"> </span>secret.yaml
<span class="gp">$</span>ANSIBLE_VAULT<span class="p">;</span><span class="m">1</span>.1<span class="p">;</span>AES256
<span class="go">31613863313562623337353430663066646236643639626635356135653165656130343036656130</span>
<span class="go">6638653365303364623965366461626262373064353462610a356164393364363266343264633938</span>
<span class="go">65323664353434616438336163636165393434633333643433636435636262353338663839626330</span>
<span class="go">3138663266346232650a373661333662366166363739303032373430373731316237386232653133</span>
<span class="go">65303366363064373039643730653339396439353736376635626434653536633361666665643938</span>
<span class="go">63373231383166363136303566316438323438333837323366623161346332376562346130336630</span>
<span class="go">35316461623263663236313961383636663936336334616132663066343562616534646163373837</span>
<span class="go">35616265313031346638653834666533393164636334643438363634303565656138373030396666</span>
<span class="go">33363035323065386166353663653462653335383232376634643064343564343338383837326666</span>
<span class="go">3932306430363162613064346437303630633239656136353831</span>
</pre></div>
</div>
</section>
<section id="view">
<h3>View<a class="headerlink" href="#view" title="Permalink to this heading"></a></h3>
<p>Для вывода на экран расшифрованное содержимое можно воспользоваться подкомандой
<code class="docutils literal notranslate"><span class="pre">view</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ansible-vault<span class="w"> </span>view<span class="w"> </span>secret.yaml
<span class="go">Vault password:</span>
<span class="go">item: secret_data</span>
<span class="go">list:</span>
<span class="go">- secret_item1</span>
<span class="go">- secret_item2</span>
<span class="go">- secret_item3</span>
<span class="go">dict:</span>
<span class="go">  key1: secret_value</span>
<span class="go">  key2: secret_value</span>
</pre></div>
</div>
</section>
<section id="edit">
<h3>Edit<a class="headerlink" href="#edit" title="Permalink to this heading"></a></h3>
<p>Отредактировать же можно подкомандой <code class="docutils literal notranslate"><span class="pre">edit</span></code>, которая также откроет текстовый
редактор как в команде <code class="docutils literal notranslate"><span class="pre">create</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ansible-vault<span class="w"> </span>edit<span class="w"> </span>secret.yaml
<span class="go">Vault password:</span>

<span class="go">item: secret_data</span>
<span class="go">list:</span>
<span class="go">- secret_item1</span>
<span class="go">- secret_item2</span>
<span class="go">- secret_item3</span>
<span class="go">dict:</span>
<span class="go">  key1: secret_value1</span>
<span class="go">  key2: secret_value2</span>
<span class="go">~</span>
<span class="go">~</span>
<span class="go">&lt;ocal-71616c9rq5j8/tmpjkj4ar9i.yaml&quot; 8L, 119B written   8,21  All</span>
</pre></div>
</div>
</section>
<section id="encrypt-decrypt">
<h3>Encrypt/Decrypt<a class="headerlink" href="#encrypt-decrypt" title="Permalink to this heading"></a></h3>
<p>Расшифровать и зашифровать файл на месте можно соответственно подкомандами
<code class="docutils literal notranslate"><span class="pre">decrypt</span></code> и <code class="docutils literal notranslate"><span class="pre">encrypt</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>cat<span class="w"> </span>secret.yaml
<span class="gp">$</span>ANSIBLE_VAULT<span class="p">;</span><span class="m">1</span>.1<span class="p">;</span>AES256
<span class="go">34366264616236613863303231396132373635323130323065396661633236363866663634393236</span>
<span class="go">3363316662656535633930636632613733373932353935350a363766353231373364346230646634</span>
<span class="go">31363936663633373630326131356435323037663533616265326234643264353631316166373761</span>
<span class="go">3932386630653432620a623063383932623436326663633435393232316166393130613465393231</span>
<span class="go">39346339333839653232323431346539616362326139356636356639316630666435376233616431</span>
<span class="go">32666438356466346633633835363232383534316164343636633136313863643163666663383766</span>
<span class="go">30313130376161386366636565653334313036313332313435356330636234633732616366653263</span>
<span class="go">63393035383765623562626531633238306133633066666434386666656131666663623062356366</span>
<span class="go">37623233623162313339333237356533326566663038323561336138393462386633616538323436</span>
<span class="go">3633663062373631666539653036633034383834376161366161</span>
<span class="gp">$ </span>ansible-vault<span class="w"> </span>decrypt<span class="w"> </span>secret.yaml
<span class="go">Vault password:</span>
<span class="go">Decryption successful</span>
<span class="gp">$ </span>cat<span class="w"> </span>secret.yaml
<span class="go">item: secret_data</span>
<span class="go">list:</span>
<span class="go">- secret_item1</span>
<span class="go">- secret_item2</span>
<span class="go">- secret_item3</span>
<span class="go">dict:</span>
<span class="go">  key1: secret_value1</span>
<span class="go">  key2: secret_value2</span>
<span class="gp">$ </span>ansible-vault<span class="w"> </span>encrypt<span class="w"> </span>secret.yaml
<span class="go">New Vault password:</span>
<span class="go">Confirm New Vault password:</span>
<span class="go">Encryption successful</span>
<span class="gp">$ </span>cat<span class="w"> </span>secret.yaml
<span class="gp">$</span>ANSIBLE_VAULT<span class="p">;</span><span class="m">1</span>.1<span class="p">;</span>AES256
<span class="go">64323737633536313039393432653135396563333538623538376133383062323961353033346330</span>
<span class="go">3439633434393039303633393066373437643938626130320a326466323566306535373231636639</span>
<span class="go">65653833613634313835646339303935653336663037306238386334373661393830633736383866</span>
<span class="go">3039363536303833640a373735636334373535383034666533633533316539646165333034343739</span>
<span class="go">66383335613736316565356535383137373562386664656232636332616261623132353834356433</span>
<span class="go">31626332623033613535383264646534393436356230386262323135353738343634393939656531</span>
<span class="go">38663339383330656637623037663930386539383639336337646230373534623165656665376562</span>
<span class="go">64366463343939613863643333313538623365366632393131323137623535666164343565376361</span>
<span class="go">30343538356464323461643734363432643935653263336631343062333835396161313135343164</span>
<span class="go">3734643933313330396133643230646639383439386566396436</span>
</pre></div>
</div>
</section>
<section id="playbook">
<h3>Playbook<a class="headerlink" href="#playbook" title="Permalink to this heading"></a></h3>
<p>Зашифрованные файлы с помощью <code class="docutils literal notranslate"><span class="pre">ansible-vault</span></code> можно использовать в плейбуках.
Создадим файл <code class="docutils literal notranslate"><span class="pre">playbook.yaml</span></code>, который будет использовать наш зашифрованный файл:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nn">---</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">localhost</span>
<span class="w">  </span><span class="nt">connection</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local</span>
<span class="w">  </span><span class="nt">gather_facts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">False</span>
<span class="w">  </span><span class="nt">vars_files</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">secret.yaml</span>
<span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">    </span><span class="nt">debug</span><span class="p">:</span>
<span class="w">      </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">list</span><span class="nv"> </span><span class="s">}}&quot;</span>
</pre></div>
</div>
<p>И запустим его указав опцию <code class="docutils literal notranslate"><span class="pre">--ask-vault-pass</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ansible-playbook<span class="w"> </span>playbook.yaml<span class="w"> </span>--ask-vault-pass
<span class="go">Vault password:</span>

<span class="go">PLAY [localhost] *****************************************************************</span>

<span class="go">TASK [test] **********************************************************************</span>
<span class="go">ok: [localhost] =&gt; {</span>
<span class="go">    &quot;msg&quot;: [</span>
<span class="go">        &quot;secret_item1&quot;,</span>
<span class="go">        &quot;secret_item2&quot;,</span>
<span class="go">        &quot;secret_item3&quot;</span>
<span class="go">    ]</span>
<span class="go">}</span>

<span class="go">PLAY RECAP ***********************************************************************</span>
<span class="go">localhost                  : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span>
</pre></div>
</div>
<p>Таким образом во время запуска мы можем получить доступ к секретным данным и
использовать их в плейбуках.</p>
</section>
<section id="encrypt-string">
<h3>Encrypt string<a class="headerlink" href="#encrypt-string" title="Permalink to this heading"></a></h3>
<p>Также с помощью подкоманды <code class="docutils literal notranslate"><span class="pre">encrypt_string</span></code> можно зашифровать переданную строку,
которую можно указать как аргумент или же через стандартный ввод:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ansible-vault<span class="w"> </span>encrypt_string
<span class="go">New Vault password:</span>
<span class="go">Confirm New Vault password:</span>
<span class="go">Reading plaintext input from stdin. (ctrl-d to end input, twice if your content does not already have a newline)</span>
<span class="go">secretString</span>
<span class="go">Encryption successful</span>
<span class="go">!vault |</span>
<span class="gp">          $</span>ANSIBLE_VAULT<span class="p">;</span><span class="m">1</span>.1<span class="p">;</span>AES256
<span class="go">          65623232363334306166353539343338613238646362643462356237626130383064363932363135</span>
<span class="go">          6166396634326366323666613339646262323935346534330a626137666161376538373661393733</span>
<span class="go">          62646535663135303733626336393837363233396162383864333263393939393039663465386232</span>
<span class="go">          3334653638656537330a386365653664336333633134303235393134313161373936333161366636</span>
</pre></div>
</div>
<p>После чего вывод команды также можно использовать в плейбуке:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nn">---</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">localhost</span>
<span class="w">  </span><span class="nt">connection</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local</span>
<span class="w">  </span><span class="nt">gather_facts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">False</span>
<span class="w">  </span><span class="nt">vars</span><span class="p">:</span>
<span class="w">    </span><span class="nt">data</span><span class="p">:</span><span class="w"> </span><span class="kt">!vault</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">      </span><span class="no">$ANSIBLE_VAULT;1.1;AES256</span>
<span class="w">      </span><span class="no">61616430323334633331373333363932376264626439346465623139336363616161656132346164</span>
<span class="w">      </span><span class="no">3330316666323662303665343261323535303738303861660a623538313730653137333364353836</span>
<span class="w">      </span><span class="no">66353866646534623536326435373362386134653862383430313930343933663961666239343064</span>
<span class="w">      </span><span class="no">3635633834383536320a323866396462653830623338656334353430303639353836376232643563</span>
<span class="w">      </span><span class="no">6266</span>
<span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">    </span><span class="nt">debug</span><span class="p">:</span>
<span class="w">      </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">data</span><span class="nv"> </span><span class="s">}}&quot;</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ansible-playbook<span class="w"> </span>playbook.yaml<span class="w"> </span>--ask-vault-pass
<span class="go">Vault password:</span>

<span class="go">PLAY [localhost] *****************************************************************</span>

<span class="go">TASK [test] **********************************************************************</span>
<span class="go">ok: [localhost] =&gt; {</span>
<span class="go">    &quot;msg&quot;: &quot;secretData\n&quot;</span>
<span class="go">}</span>

<span class="go">PLAY RECAP ***********************************************************************</span>
<span class="go">localhost                  : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span>
</pre></div>
</div>
</section>
</section>
<section id="age">
<h2>Age<a class="headerlink" href="#age" title="Permalink to this heading"></a></h2>
<p>Также познакомимся с утилитой <a class="reference external" href="https://github.com/FiloSottile/age">age</a>, которая не привязана ни к какому стеку и
позволяющая очень просто использовать ключи шифрования помимо парольной фразы
для шифрования локальных файлов.</p>
<p>В качестве файла возьмем <code class="docutils literal notranslate"><span class="pre">secret.yaml</span></code> из предыдущего, не забыв расшифровать его,
если он был зашифрован утилитой <code class="docutils literal notranslate"><span class="pre">ansible-vault</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ansible-vault<span class="w"> </span>decrypt<span class="w"> </span>secret.yaml
<span class="go">Vault password:</span>
<span class="go">Decryption successful</span>
<span class="gp">$ </span>cat<span class="w"> </span>secret.yaml
<span class="go">item: secret_data</span>
<span class="go">list:</span>
<span class="go">- secret_item1</span>
<span class="go">- secret_item2</span>
<span class="go">- secret_item3</span>
<span class="go">dict:</span>
<span class="go">  key1: secret_value1</span>
<span class="go">  key2: secret_value2</span>
</pre></div>
</div>
<section id="keygen">
<h3>Keygen<a class="headerlink" href="#keygen" title="Permalink to this heading"></a></h3>
<p>Для генерации ключа воспользуемся командой <code class="docutils literal notranslate"><span class="pre">age-keygen</span></code> и сохраним его в файл
<code class="docutils literal notranslate"><span class="pre">key.txt</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>age-keygen<span class="w"> </span>-o<span class="w"> </span>key.txt
<span class="go">Public key: age1m7dhpf204lsx6d5h56s0e96nudvjqaa2g929ec0y83tncu6umpxq7egxmp</span>
<span class="gp">$ </span>age-keygen<span class="w"> </span>-y<span class="w"> </span>key.txt
<span class="go">age1m7dhpf204lsx6d5h56s0e96nudvjqaa2g929ec0y83tncu6umpxq7egxmp</span>
</pre></div>
</div>
<p>Как видно при генерации ключа на экран выводится его публичная часть, которую
также можно посмотреть с помощью опции <code class="docutils literal notranslate"><span class="pre">-y</span></code> у уже созданного ключа.</p>
</section>
<section id="encrypt">
<h3>Encrypt<a class="headerlink" href="#encrypt" title="Permalink to this heading"></a></h3>
<p>Для шифрования файла как раз необходима публичная часть ключа, которая указывается
в опции <code class="docutils literal notranslate"><span class="pre">-r</span></code> команды <code class="docutils literal notranslate"><span class="pre">age</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="c1"># сохранить зашифрованный файл в бинарном формате</span>
<span class="gp">$ </span>age<span class="w"> </span>-r<span class="w"> </span>age1m7dhpf204lsx6d5h56s0e96nudvjqaa2g929ec0y83tncu6umpxq7egxmp<span class="w"> </span>-o<span class="w"> </span>secret.yaml.age<span class="w"> </span>secret.yaml
<span class="gp">$ </span><span class="c1"># сохранить зашифрованный файл в PEM формате</span>
<span class="gp">$ </span>age<span class="w"> </span>-r<span class="w"> </span>age1m7dhpf204lsx6d5h56s0e96nudvjqaa2g929ec0y83tncu6umpxq7egxmp<span class="w"> </span>-a<span class="w"> </span>secret.yaml<span class="w"> </span>&gt;<span class="w"> </span>secret.yaml.age
<span class="gp">$ </span>cat<span class="w"> </span>secret.yaml.age
<span class="go">-----BEGIN AGE ENCRYPTED FILE-----</span>
<span class="go">YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBrVEVpc2dmYUgvYU1FaERO</span>
<span class="go">UEtzcCtQbDlyVW9CZkVFMC9SVXlqbk5iWEhrCjVPbUdYQ2pMTFhYaWhtWkZsVmh6</span>
<span class="go">Y3ZUdE0rV21yMkpIS3k0bUJSdGMzdjQKLS0tIFZrR3lwZVRud2F0ZXNuVHFHaHpz</span>
<span class="go">bTE2QStkS2wvNzJwcWVRdHFaVjF5WEEKZEyOM+f8EcO8ZD3j5YLJeHffJiRW+ZCD</span>
<span class="go">FBy1PpyTkZ8DyZJvY1oDeIUJRD759eOrrR933xIj6ykwUpD1UiO5cUF8KRqHRdgr</span>
<span class="go">aSjIKrixWs3Y84saca+p+z67nLMSs3vpnB8TdrvKS65GWsHGQ3gvEzDnDqhMV4DC</span>
<span class="go">pIRRr5xsEmtjhezQoC0h/Q2apcLKSwt5ILoZ14RMNQ==</span>
<span class="go">-----END AGE ENCRYPTED FILE-----</span>
</pre></div>
</div>
</section>
<section id="decrypt">
<h3>Decrypt<a class="headerlink" href="#decrypt" title="Permalink to this heading"></a></h3>
<p>Для расшифровывания файла необходимо использовать ключ <code class="docutils literal notranslate"><span class="pre">-d</span></code> и <code class="docutils literal notranslate"><span class="pre">-i</span></code> с указанием
файла ключа:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>age<span class="w"> </span>-d<span class="w"> </span>-i<span class="w"> </span>key.txt<span class="w"> </span>secret.yaml.age
<span class="go">item: secret_data</span>
<span class="go">list:</span>
<span class="go">- secret_item1</span>
<span class="go">- secret_item2</span>
<span class="go">- secret_item3</span>
<span class="go">dict:</span>
<span class="go">  key1: secret_value1</span>
<span class="go">  key2: secret_value2</span>
</pre></div>
</div>
</section>
<section id="ssh-key">
<h3>SSH Key<a class="headerlink" href="#ssh-key" title="Permalink to this heading"></a></h3>
<p>Для шифрования также есть возможность использовать ssh ключи, которые обычно есть
у любого разработчика:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ssh-keygen<span class="w"> </span>-P<span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span>-f<span class="w"> </span><span class="nv">$HOME</span>/.ssh/id_rsa
<span class="go">Generating public/private rsa key pair.</span>
<span class="go">Your identification has been saved in /home/vagrant/.ssh/id_rsa</span>
<span class="go">Your public key has been saved in /home/vagrant/.ssh/id_rsa.pub</span>
<span class="go">The key fingerprint is:</span>
<span class="go">SHA256:CWCVKKgOUcVJ1WUp/ct8we8pVDsLQdI3dL8M8upx72k vagrant@node</span>
<span class="go">The key&#39;s randomart image is:</span>
<span class="go">+---[RSA 3072]----+</span>
<span class="go">| o.+==oo oo.. ...|</span>
<span class="go">|o ..+.. o.o. o oo|</span>
<span class="go">|.. .  .  . ooo. o|</span>
<span class="go">|o      . .  +.=..|</span>
<span class="go">|o       S  o oo=.|</span>
<span class="go">| .          =o.o.|</span>
<span class="go">|           o.o..+|</span>
<span class="go">|          . o..Eo|</span>
<span class="go">|           .  ++ |</span>
<span class="go">+----[SHA256]-----+</span>
<span class="gp">$ </span>age<span class="w"> </span>-R<span class="w"> </span><span class="nv">$HOME</span>/.ssh/id_rsa.pub<span class="w"> </span>-a<span class="w"> </span>secret.yaml<span class="w"> </span>&gt;<span class="w"> </span>secret.yaml.age
<span class="gp">$ </span>age<span class="w"> </span>-d<span class="w"> </span>-i<span class="w"> </span><span class="nv">$HOME</span>/.ssh/id_rsa<span class="w"> </span>secret.yaml.age
<span class="go">item: secret_data</span>
<span class="go">list:</span>
<span class="go">- secret_item1</span>
<span class="go">- secret_item2</span>
<span class="go">- secret_item3</span>
<span class="go">dict:</span>
<span class="go">  key1: secret_value1</span>
<span class="go">  key2: secret_value2</span>
</pre></div>
</div>
</section>
<section id="multiple-keys">
<h3>Multiple keys<a class="headerlink" href="#multiple-keys" title="Permalink to this heading"></a></h3>
<p>А также для шифрования можно одновременно использовать несколько ключей,
комбинируя как age ключи так и ssh:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>age<span class="w"> </span>-r<span class="w"> </span>age1m7dhpf204lsx6d5h56s0e96nudvjqaa2g929ec0y83tncu6umpxq7egxmp<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-R<span class="w"> </span><span class="nv">$HOME</span>/.ssh/id_rsa.pub<span class="w"> </span>-a<span class="w"> </span>secret.yaml<span class="w"> </span>&gt;<span class="w"> </span>secret.yaml.age
<span class="gp">$ </span>age<span class="w"> </span>-d<span class="w"> </span>-i<span class="w"> </span><span class="nv">$HOME</span>/.ssh/id_rsa<span class="w"> </span>secret.yaml.age
<span class="go">item: secret_data</span>
<span class="go">list:</span>
<span class="go">- secret_item1</span>
<span class="go">- secret_item2</span>
<span class="go">- secret_item3</span>
<span class="go">dict:</span>
<span class="go">  key1: secret_value1</span>
<span class="go">  key2: secret_value2</span>
<span class="gp">$ </span>age<span class="w"> </span>-d<span class="w"> </span>-i<span class="w"> </span>key.txt<span class="w"> </span>secret.yaml.age
<span class="go">item: secret_data</span>
<span class="go">list:</span>
<span class="go">- secret_item1</span>
<span class="go">- secret_item2</span>
<span class="go">- secret_item3</span>
<span class="go">dict:</span>
<span class="go">  key1: secret_value1</span>
<span class="go">  key2: secret_value2</span>
</pre></div>
</div>
<p>Таким образом можно хранить файл с открытыми ключами нескольких пользователей,
например, там же где и файл с секретами. При этом каждый пользователь сможет
читать, изменять и перешифровывать такой файл без знания общей парольной фразы.</p>
</section>
</section>
<section id="sops">
<h2>Sops<a class="headerlink" href="#sops" title="Permalink to this heading"></a></h2>
<p>Еще один инструмент для управления секретами - <a class="reference external" href="https://github.com/getsops/sops">SOPS: Secrets OPerationS</a>.
Данный инструмент использует внешнего поставщика ключей для шифрования - это
могут быть <a class="reference external" href="https://github.com/FiloSottile/age">age</a> и <a class="reference external" href="https://www.gnupg.org/">gpg</a> как локальные утилиты, так и облачные KMS сервисы.</p>
<section id="gpg">
<h3>GPG<a class="headerlink" href="#gpg" title="Permalink to this heading"></a></h3>
<p>Рассмотрим работу <a class="reference external" href="https://github.com/getsops/sops">sops</a> в связке с <a class="reference external" href="https://ru.wikipedia.org/wiki/PGP">pgp</a> ключами. Для этого с помощью
утилиты <a class="reference external" href="https://www.gnupg.org/">gpg</a> создадим себе ключевую пару.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>gpg<span class="w"> </span>--quick-gen-key<span class="w"> </span>--pinentry-mode<span class="o">=</span>loopback<span class="w"> </span>--passphrase<span class="o">=</span><span class="s1">&#39;&#39;</span><span class="w"> </span>Alex<span class="w"> </span>default<span class="w"> </span>default<span class="w"> </span><span class="m">0</span>
<span class="go">gpg: directory &#39;/home/vagrant/.gnupg&#39; created</span>
<span class="go">gpg: keybox &#39;/home/vagrant/.gnupg/pubring.kbx&#39; created</span>
<span class="go">gpg: /home/vagrant/.gnupg/trustdb.gpg: trustdb created</span>
<span class="go">gpg: directory &#39;/home/vagrant/.gnupg/openpgp-revocs.d&#39; created</span>
<span class="go">gpg: revocation certificate stored as &#39;/home/vagrant/.gnupg/openpgp-revocs.d/4D9DC3B8A580D927DEC9D4325A66620A06DF7D54.rev&#39;</span>
<span class="go">public and secret key created and signed.</span>

<span class="go">pub   rsa3072 2023-11-15 [SC]</span>
<span class="go">      4D9DC3B8A580D927DEC9D4325A66620A06DF7D54</span>
<span class="go">uid                      Alex</span>
<span class="go">sub   rsa3072 2023-11-15 [E]</span>
</pre></div>
</div>
</section>
<section id="id1">
<h3>Encrypt<a class="headerlink" href="#id1" title="Permalink to this heading"></a></h3>
<p>Для шифрования с помощью <a class="reference external" href="https://ru.wikipedia.org/wiki/PGP">pgp</a> необходимо использовать отпечаток ключа. Можно
его передавать через аргументы или переменную среды, но удобнее использовать
файл конфигурации, который также можно хранить вместе с проектом, где будут
храниться секреты. Создадим файл <code class="docutils literal notranslate"><span class="pre">.sops.yaml</span></code> в который добавим отпечаток ключа:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">creation_rules</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">pgp</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;-</span>
<span class="w">        </span><span class="no">4D9DC3B8A580D927DEC9D4325A66620A06DF7D54</span>
</pre></div>
</div>
<p><a class="reference external" href="https://github.com/getsops/sops">Sops</a> умеет работать со структурированными форматами файлов такие как
<code class="docutils literal notranslate"><span class="pre">json</span></code>, <code class="docutils literal notranslate"><span class="pre">yaml</span></code>, <code class="docutils literal notranslate"><span class="pre">env</span></code>, таким образом позволяя частично шифровать данные.
Тип файла по-умолчанию определяется по расширению, так что, для того чтобы
зашифровать <code class="docutils literal notranslate"><span class="pre">yaml</span></code> файл полностью, необходимо указать его тип как <code class="docutils literal notranslate"><span class="pre">binary</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sops<span class="w"> </span>-e<span class="w"> </span>--input-type<span class="w"> </span>binary<span class="w"> </span>secret.yaml
<span class="go">data: ENC[AES256_GCM,data:zpeGBft25RTki9dM9wzezpWBUstltnpsG2AM89kl9ZcL3ovj+8ugiQNMc0NaLDZo6OZjbCD6WcDrUQZTMgr8l8DIVhlQE1wcachu3tc4QLo2Ha77Sf37tXry8EgBknShtK3V1kcTgJZ/R0tahL4n1zdVr165FIk=,iv:9uvmPz5fuYc9OY+gWEmAWqUJn2Rgw1Rlf+05VbTr7Oc=,tag:ueirLeHOMfHHC1hBWOZtOg==,type:str]</span>
<span class="go">sops:</span>
<span class="go">    kms: []</span>
<span class="go">    gcp_kms: []</span>
<span class="go">    azure_kv: []</span>
<span class="go">    hc_vault: []</span>
<span class="go">    age: []</span>
<span class="go">    lastmodified: &quot;2023-11-15T20:20:22Z&quot;</span>
<span class="go">    mac: ENC[AES256_GCM,data:A+eNt5DtQiISq6YEYyUwn2tG4Loxsw2AWeLgfpsffMR0u+6Ob7NECn/cRjF6Ik5Drun2CYCla0/vRbpPi1aVvyfVpxTMaLWyJJdErX6nxZ00ojqlwM1ehPJaRPSUStuTuV9uiqAMCwt3DVHwiRQUNKP0S7W1N41HC1XijfI3iNw=,iv:0YEdmAiDVDYiprZV5yyddpwqRJzLUS5aDDHsQYkThKM=,tag:OLi6Y3VKScG6lC36dAY/3w==,type:str]</span>
<span class="go">    pgp:</span>
<span class="go">        - created_at: &quot;2023-11-15T20:20:22Z&quot;</span>
<span class="go">          enc: |-</span>
<span class="go">            -----BEGIN PGP MESSAGE-----</span>

<span class="go">            hQGMA87ESxgiPDlNAQv8DxE8QWoASICvC1P08kejqe8zdBeY0HkSbhpbPbu1CnxO</span>
<span class="go">            vPkp16XFa1EyR2nSR66tRubq6PYuQeZ1yJuPL55zA80Iu7WhUNDgXNc9/aBaEMTz</span>
<span class="go">            /kQ/LXfA5eN6vXP1NO7WTuh7x7BiQi+N3+HOYVYWYleckzgffpHiLIGSM5LpLPBt</span>
<span class="go">            W2OK3NVw/s/hQsXv04AqpKTZCm2o97LvpytceiGylhKWd8MacM2wnHBLs+Sz9Ubq</span>
<span class="go">            dMawcvipCx03FL5BFSDVbaZ4UK7BDMr/fAXF5l5EO4fIj8ghICjJN7wgWutTKUZq</span>
<span class="go">            BK/dGFp/FiDZ4SLCRr+N9Eo5v45aFA3eLP71QHSfAitKKnqlQ7pER0Y9BdBVGBaj</span>
<span class="go">            9v3HU3x7ebObRDaHdhuCACWOyJPiQaEHVAnH2dTrkwGEkIku89DROIFQOjEEOi96</span>
<span class="go">            rGdGDRX+bY0qHUSomZ/wiQNCL2DBg/PWwxqBb5F84DJiQ9pH7McTiO0CHro9prz6</span>
<span class="go">            SpCdEJ+5KPWIWTDIG55f0lwBmriqg8BjYn3O5HYHXCBgveWi9LpROcUTUJPqsjBW</span>
<span class="go">            SdrWTMsVywXZUAjw9JldMLIFKyZFKTmdnV2LhxSAi8icXAWOboz+qV9RaunVPMI0</span>
<span class="go">            VJ/RPTXrq/B3G+MvWQ==</span>
<span class="go">            =mGt8</span>
<span class="go">            -----END PGP MESSAGE-----</span>
<span class="go">          fp: 4D9DC3B8A580D927DEC9D4325A66620A06DF7D54</span>
<span class="go">    unencrypted_suffix: _unencrypted</span>
<span class="go">    version: 3.8.1</span>
</pre></div>
</div>
<p>Как видно зашифрованное содержимое выводится на экран по-умолчанию, для сохранения
в другой файл можно использовать опцию <code class="docutils literal notranslate"><span class="pre">--output</span></code>, либо же опцию <code class="docutils literal notranslate"><span class="pre">-i</span></code>(<code class="docutils literal notranslate"><span class="pre">--in-place</span></code>)
для изменения текущего файла. Попробуем использовать частичное шифрование
структурированного файла изменив его содержимое:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sops<span class="w"> </span>-e<span class="w"> </span>-i<span class="w"> </span>secret.yaml
<span class="gp">$ </span>cat<span class="w"> </span>secret.yaml
<span class="go">item: ENC[AES256_GCM,data:6C16dZrteSU++Kk=,iv:SPmmwTlhDP6wkY1w4S6rosNQoE7XlG59D/WXoa0sPZg=,tag:SGwzUMqIVWOOro4oQyypyg==,type:str]</span>
<span class="go">list:</span>
<span class="go">    - ENC[AES256_GCM,data:PiLZhs/ED3q3dMfc,iv:XsfueJtWRfKj7Opx4pZd2ViUQtrbLIXizS8ETGtUafw=,tag:RdBMCOppAZoNLgt4daBU7w==,type:str]</span>
<span class="go">    - ENC[AES256_GCM,data:D25wWO4I9drqxCTS,iv:C+mxtvYas+N7+BhCaqji4p3zodQLBYCZ617YDz4j100=,tag:+wGmRERrjnzr9hnkLTnHNw==,type:str]</span>
<span class="go">    - ENC[AES256_GCM,data:SqMsPlWAtVYCsoE4,iv:Z06k7lccdL8NrdDCXjjpqfWp+/zqkzwAVfUZeFOo+E0=,tag:7e/60SQ41oYt/8xbPVE4YA==,type:str]</span>
<span class="go">dict:</span>
<span class="go">    key1: ENC[AES256_GCM,data:ghZWn233f1DcWTpLNw==,iv:1TnxUTA4KPVVhVmE22wqRGb2QG5h3FEwmBLZlh821z4=,tag:MkrdB1u5W5EHGPgRLjucmQ==,type:str]</span>
<span class="go">    key2: ENC[AES256_GCM,data:LP7JVUQnk6NGKIeEVQ==,iv:X1YSuh/Fum2E5E7mQco9bi335WreI6DdqM17Zvksk70=,tag:PqjofaBgFZ1rEtuHAI1loA==,type:str]</span>
<span class="go">sops:</span>
<span class="go">...</span>
</pre></div>
</div>
</section>
<section id="id2">
<h3>Edit<a class="headerlink" href="#id2" title="Permalink to this heading"></a></h3>
<p>Если использовать команду <code class="docutils literal notranslate"><span class="pre">sops</span></code> передав лишь имя зашифрованного файла, то
по-умолчанию открывается текстовый редактор определенный в переменной <code class="docutils literal notranslate"><span class="pre">EDITOR</span></code>
с расшифрованным содержимым файла, который можно отредактировать и он повторно
будет зашифрован:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nv">EDITOR</span><span class="o">=</span>nano<span class="w"> </span>sops<span class="w"> </span>secret.yaml
<span class="go">  GNU nano 7.2                /tmp/1481366927/secret.yaml *</span>
<span class="go">item: secret_data</span>
<span class="go">list:</span>
<span class="go">    - secret_item1</span>
<span class="go">    - secret_item2</span>
<span class="go">    - secret_item3</span>
<span class="go">dict:</span>
<span class="go">    key1: secret_value3</span>
<span class="go">    key2: secret_value2</span>

<span class="go">                                 [ Read 8 lines ]</span>
<span class="go">^G Help      ^O Write Out ^W Where Is  ^K Cut       ^T Execute   ^C Location</span>
<span class="go">^X Exit      ^R Read File ^\ Replace   ^U Paste     ^J Justify   ^/ Go To Line</span>
</pre></div>
</div>
</section>
<section id="set-extract">
<h3>Set/Extract<a class="headerlink" href="#set-extract" title="Permalink to this heading"></a></h3>
<p>С помощью опции <code class="docutils literal notranslate"><span class="pre">--extract</span></code> вместе с опцией <code class="docutils literal notranslate"><span class="pre">-d</span></code> можно расшифровать только
нужные части файла указав путь до них:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sops<span class="w"> </span>-d<span class="w"> </span>--extract<span class="w"> </span><span class="s1">&#39;[&quot;item&quot;]&#39;</span><span class="w"> </span>secret.yaml
<span class="go">secret_data</span>
<span class="gp">$ </span>sops<span class="w"> </span>-d<span class="w"> </span>--extract<span class="w"> </span><span class="s1">&#39;[&quot;list&quot;][0]&#39;</span><span class="w"> </span>secret.yaml
<span class="go">secret_item1</span>
</pre></div>
</div>
<p>А с помощью опции <code class="docutils literal notranslate"><span class="pre">--set</span></code> можно таким же образом устанавливать значения:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sops<span class="w"> </span>-d<span class="w"> </span>--extract<span class="w"> </span><span class="s1">&#39;[&quot;dict&quot;][&quot;key1&quot;]&#39;</span><span class="w"> </span>secret.yaml
<span class="go">secret_value3</span>
<span class="gp">$ </span>sops<span class="w"> </span>--set<span class="w"> </span><span class="s1">&#39;[&quot;dict&quot;][&quot;key1&quot;] &quot;secret_value1&quot;&#39;</span><span class="w"> </span>secret.yaml
<span class="gp">$ </span>sops<span class="w"> </span>-d<span class="w"> </span>--extract<span class="w"> </span><span class="s1">&#39;[&quot;dict&quot;][&quot;key1&quot;]&#39;</span><span class="w"> </span>secret.yaml
<span class="go">secret_value1</span>
</pre></div>
</div>
<p>Таким образом возможно удобное использование в скриптах и CI/CD пайплайнах.</p>
</section>
<section id="exec-file-env">
<h3>Exec File/Env<a class="headerlink" href="#exec-file-env" title="Permalink to this heading"></a></h3>
<p>С помощью подкоманды <code class="docutils literal notranslate"><span class="pre">exec-file</span></code> можно вызвать какое-либо другое приложение,
которому передастся расшифрованный временный файл:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sops<span class="w"> </span>exec-file<span class="w"> </span>secret.yaml<span class="w"> </span><span class="s1">&#39;cat {}&#39;</span>
<span class="go">item: secret_data</span>
<span class="go">list:</span>
<span class="go">    - secret_item1</span>
<span class="go">    - secret_item2</span>
<span class="go">    - secret_item3</span>
<span class="go">dict:</span>
<span class="go">    key1: secret_value1</span>
<span class="go">    key2: secret_value2</span>
</pre></div>
</div>
<p>Также есть возможность запустить приложение задав ему переменные среды из
зашифрованного файла:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;VAR1=VALUE1\nVAR2=VALUE2&quot;</span><span class="w"> </span>&gt;<span class="w"> </span>.env
<span class="gp">$ </span>sops<span class="w"> </span>-e<span class="w"> </span>-i<span class="w"> </span>.env
<span class="gp">$ </span>sops<span class="w"> </span>exec-env<span class="w"> </span>.env<span class="w"> </span><span class="s1">&#39;sh -c &quot;echo $VAR1 $VAR2&quot;&#39;</span>
<span class="go">VALUE1 VALUE2</span>
</pre></div>
</div>
</section>
<section id="update-keys">
<h3>Update keys<a class="headerlink" href="#update-keys" title="Permalink to this heading"></a></h3>
<p>Для изменения ключей шифрования, например когда нужно добавить ключи новых
пользователей или удалить старых, есть подкоманда <code class="docutils literal notranslate"><span class="pre">updatekeys</span></code>. Добавим наш
age ключ в <code class="docutils literal notranslate"><span class="pre">.sops.yaml</span></code>:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">creation_rules</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">pgp</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;-</span>
<span class="w">    </span><span class="no">4D9DC3B8A580D927DEC9D4325A66620A06DF7D54</span>
<span class="w">  </span><span class="nt">age</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">age1m7dhpf204lsx6d5h56s0e96nudvjqaa2g929ec0y83tncu6umpxq7egxmp</span>
</pre></div>
</div>
<p>И обновим:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sops<span class="w"> </span>updatekeys<span class="w"> </span>secret.yaml
<span class="go">2023/11/15 21:32:44 Syncing keys for file /vagrant/secret.yaml</span>
<span class="go">The following changes will be made to the file&#39;s groups:</span>
<span class="go">Group 1</span>
<span class="go">    4D9DC3B8A580D927DEC9D4325A66620A06DF7D54</span>
<span class="go">+++ age1m7dhpf204lsx6d5h56s0e96nudvjqaa2g929ec0y83tncu6umpxq7egxmp</span>
<span class="go">Is this okay? (y/n):y</span>
<span class="go">2023/11/15 21:32:46 File /vagrant/secret.yaml synced with new keys</span>
</pre></div>
</div>
<p>Таким образом можно управлять доступом пользователей к секретам.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Нижняя область">
        <a href="10_practice_saltstack_reactor.html" class="btn btn-neutral float-left" title="Salt Beacons/Reactors and IaC" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Предыдущая</a>
        <a href="12_practice_vault.html" class="btn btn-neutral float-right" title="Vault" accesskey="n" rel="next">Следующая <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Алексей Юдолевич.</p>
  </div>

  Собрано при помощи <a href="https://www.sphinx-doc.org/">Sphinx</a> с использованием
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">темы,</a>
    предоставленной <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>