<!DOCTYPE html>
<html class="writer-html5" lang="ru" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Docker Images &mdash; документация infra-course </title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/copybutton.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
        <script src="_static/clipboard.min.js"></script>
        <script src="_static/copybutton.js"></script>
        <script src="_static/translations.js"></script>
        <script src="https://unpkg.com/mermaid@9.4.0/dist/mermaid.min.js"></script>
        <script>mermaid.initialize({startOnLoad:true});</script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Алфавитный указатель" href="genindex.html" />
    <link rel="search" title="Поиск" href="search.html" />
    <link rel="next" title="Docker Volume/Network" href="05_practice_docker_volume_network.html" />
    <link rel="prev" title="Docker" href="03_practice_docker.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            infra-course
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Поиск в документации" aria-label="Поиск в документации" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Меню навигации">
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="practice.html">Практика</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="01_practice_vagrant.html">Vagrant</a></li>
<li class="toctree-l2"><a class="reference internal" href="02_practice_vagrant.html">Vagrant Multi-Node</a></li>
<li class="toctree-l2"><a class="reference internal" href="03_practice_docker.html">Docker</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Docker Images</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#vagrant">Vagrant</a></li>
<li class="toctree-l3"><a class="reference internal" href="#dockerfile">Dockerfile</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#hello">Hello</a></li>
<li class="toctree-l4"><a class="reference internal" href="#copy-add">Copy/Add</a></li>
<li class="toctree-l4"><a class="reference internal" href="#env-arg">Env/Arg</a></li>
<li class="toctree-l4"><a class="reference internal" href="#run">Run</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cache">Cache</a></li>
<li class="toctree-l4"><a class="reference internal" href="#expose">Expose</a></li>
<li class="toctree-l4"><a class="reference internal" href="#label">Label</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cmd-entrypoint">Cmd/Entrypoint</a></li>
<li class="toctree-l4"><a class="reference internal" href="#multi-stage">Multi-Stage</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#registry">Registry</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">Run</a></li>
<li class="toctree-l4"><a class="reference internal" href="#push">Push</a></li>
<li class="toctree-l4"><a class="reference internal" href="#catalog">Catalog</a></li>
<li class="toctree-l4"><a class="reference internal" href="#tags-manifests">Tags/Manifests</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="05_practice_docker_volume_network.html">Docker Volume/Network</a></li>
<li class="toctree-l2"><a class="reference internal" href="06_practice_docker_compose.html">Docker Compose</a></li>
<li class="toctree-l2"><a class="reference internal" href="07_practice_ansible.html">Ansible</a></li>
<li class="toctree-l2"><a class="reference internal" href="08_practice_ansible_roles.html">Ansible Roles and Collections</a></li>
<li class="toctree-l2"><a class="reference internal" href="09_practice_saltstack.html">Salt</a></li>
<li class="toctree-l2"><a class="reference internal" href="10_practice_saltstack_reactor.html">Salt Beacons/Reactors and IaC</a></li>
<li class="toctree-l2"><a class="reference internal" href="11_practice_secrets.html">Secret Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="12_practice_vault.html">Vault</a></li>
<li class="toctree-l2"><a class="reference internal" href="13_practice_rabbit.html">RabbitMQ</a></li>
<li class="toctree-l2"><a class="reference internal" href="14_practice_rabbit_routing.html">RabbitMQ Routing</a></li>
<li class="toctree-l2"><a class="reference internal" href="15_practice_kafka.html">Apache Kafka</a></li>
<li class="toctree-l2"><a class="reference internal" href="16_practice_kafka_cluster.html">Apache Kafka Cluster</a></li>
<li class="toctree-l2"><a class="reference internal" href="17_practice_terraform.html">Terraform</a></li>
<li class="toctree-l2"><a class="reference internal" href="18_practice_terraform_ansible.html">Terraform + Ansible</a></li>
<li class="toctree-l2"><a class="reference internal" href="19_practice_gitlab.html">Gitlab CI</a></li>
<li class="toctree-l2"><a class="reference internal" href="20_practice_jenkins.html">Jenkins</a></li>
<li class="toctree-l2"><a class="reference internal" href="21_practice_prometheus.html">Prometheus</a></li>
<li class="toctree-l2"><a class="reference internal" href="22_practice_alertmanager.html">Alertmanager</a></li>
<li class="toctree-l2"><a class="reference internal" href="23_practice_elasticsearch.html">ELK Stack</a></li>
<li class="toctree-l2"><a class="reference internal" href="24_practice_elk_app_logs.html">ELK Log Visualization</a></li>
<li class="toctree-l2"><a class="reference internal" href="25_practice_jaeger.html">Jaeger</a></li>
<li class="toctree-l2"><a class="reference internal" href="26_practice_jaeger_e2e.html">Jaeger E2E</a></li>
<li class="toctree-l2"><a class="reference internal" href="27_practice_opentelemetry.html">Opentelemetry Collector</a></li>
<li class="toctree-l2"><a class="reference internal" href="28_practice_otel_instrumentation.html">Opentelemetry Instrumentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="29_practice_istio.html">Istio</a></li>
<li class="toctree-l2"><a class="reference internal" href="30_practice_istio_kiali.html">Kiali</a></li>
<li class="toctree-l2"><a class="reference internal" href="31_practice_argocd.html">ArgoCD</a></li>
<li class="toctree-l2"><a class="reference internal" href="32_practice_argocd_gitops.html">ArgoCD GitOps</a></li>
<li class="toctree-l2"><a class="reference internal" href="33_practice_final.html">Самостоятельная работа</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Меню навигации для мобильных устройств" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">infra-course</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Навигация по страницам">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="practice.html">Практика</a></li>
      <li class="breadcrumb-item active">Docker Images</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/04_practice_docker_images.md.txt" rel="nofollow"> Просмотреть исходный код страницы</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="docker-images">
<h1>Docker Images<a class="headerlink" href="#docker-images" title="Permalink to this heading"></a></h1>
<p>В данном практическом занятии рассматриваются операции с docker образами:
директивы Dockerfile, сборка, работа с registry.</p>
<section id="vagrant">
<h2>Vagrant<a class="headerlink" href="#vagrant" title="Permalink to this heading"></a></h2>
<p>Для работы с докером в независимости от платформы можно воспользоваться
следующим <code class="docutils literal notranslate"><span class="pre">Vagrantfile</span></code>:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="o">|</span><span class="n">config</span><span class="o">|</span>
<span class="w">  </span><span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ubuntu/lunar64&quot;</span>
<span class="w">  </span><span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span><span class="w"> </span><span class="s2">&quot;docker&quot;</span>
<span class="k">end</span>
</pre></div>
</div>
</section>
<section id="dockerfile">
<h2>Dockerfile<a class="headerlink" href="#dockerfile" title="Permalink to this heading"></a></h2>
<p><a class="reference external" href="https://docs.docker.com/engine/reference/builder/">Рассмотрим различные директивы, которые можно использовать в Dockerfile</a>.
Во всех примерах <code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code> будет находиться в директории проекта
вместе с <code class="docutils literal notranslate"><span class="pre">Vagrantfile</span></code> и внутри виртуальной машины будет доступен по пути
<code class="docutils literal notranslate"><span class="pre">/vagrant/Dockerfile</span></code>.</p>
<section id="hello">
<h3>Hello<a class="headerlink" href="#hello" title="Permalink to this heading"></a></h3>
<p>Создадим простой <a class="reference external" href="https://docs.docker.com/engine/reference/builder/">Dockerfile</a>, который содержит две директивы -
<a class="reference external" href="https://docs.docker.com/engine/reference/builder/#from"><code class="docutils literal notranslate"><span class="pre">FROM</span></code></a> для указания базового образа и <a class="reference external" href="https://docs.docker.com/engine/reference/builder/#cmd"><code class="docutils literal notranslate"><span class="pre">CMD</span></code></a> для команды, которая запустится
при старте контейнера:</p>
<div class="highlight-dockerfile notranslate"><div class="highlight"><pre><span></span><span class="k">FROM</span><span class="w"> </span><span class="s">python:3.11.5-alpine</span>
<span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;python&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;-c&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;print(&#39;hello&#39;)&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>Соберем образ с именем <code class="docutils literal notranslate"><span class="pre">hello</span></code> из данного <a class="reference external" href="https://docs.docker.com/engine/reference/builder/">Dockerfile</a>, при простом запуске увидим
как отработала команда в директиве <a class="reference external" href="https://docs.docker.com/engine/reference/builder/#cmd"><code class="docutils literal notranslate"><span class="pre">CMD</span></code></a>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>docker<span class="w"> </span>build<span class="w"> </span>-t<span class="w"> </span>hello<span class="w"> </span>/vagrant/<span class="w"> </span><span class="c1"># без указания тега образ будет иметь тег latest</span>
<span class="go">[+] Building 4.5s (5/5) FINISHED                                                docker:default</span>
<span class="go"> =&gt; [internal] load build definition from Dockerfile                                      0.0s</span>
<span class="go"> =&gt; =&gt; transferring dockerfile: 102B                                                      0.0s</span>
<span class="go"> =&gt; [internal] load .dockerignore                                                         0.0s</span>
<span class="go"> =&gt; =&gt; transferring context: 2B                                                           0.0s</span>
<span class="go"> =&gt; [internal] load metadata for docker.io/library/python:3.11.5-alpine                   1.9s</span>
<span class="go"> =&gt; [1/1] FROM docker.io/library/python:3.11.5-alpine@sha256:5d769f990397afbb2aca24b0655  2.6s</span>
<span class="go"> =&gt; =&gt; resolve docker.io/library/python:3.11.5-alpine@sha256:5d769f990397afbb2aca24b0655  0.0s</span>
<span class="go"> =&gt; =&gt; sha256:66e1d5e70e420aa86a23bd8b4eebf2a6eb60b4aff9ee8a6ca52e27 622.31kB / 622.31kB  0.3s</span>
<span class="go"> =&gt; =&gt; sha256:0448660c92fc1b6557cf48081d99028eeaba7809a1c2f23018e2331f 12.46MB / 12.46MB  1.8s</span>
<span class="go"> =&gt; =&gt; sha256:5d769f990397afbb2aca24b0655e404c0f2806d268f454b052e81e39d8 1.65kB / 1.65kB  0.0s</span>
<span class="go"> =&gt; =&gt; sha256:e5d592c422d6e527cb946ae6abb1886c511a5e163d3543865f5a5b9b61 1.37kB / 1.37kB  0.0s</span>
<span class="go"> =&gt; =&gt; sha256:b9b301ab01c2af0b5f52069b97e1d89885433dc55b6623ad6aa4a43b2e 6.26kB / 6.26kB  0.0s</span>
<span class="go"> =&gt; =&gt; sha256:7264a8db6415046d36d16ba98b79778e18accee6ffa71850405994cffa 3.40MB / 3.40MB  0.7s</span>
<span class="go"> =&gt; =&gt; sha256:3ce23f846e315e35618c4604547bbe6aa2b48a0601c335c76b8fe02729bb5c 241B / 241B  0.8s</span>
<span class="go"> =&gt; =&gt; extracting sha256:7264a8db6415046d36d16ba98b79778e18accee6ffa71850405994cffa9be7d  0.1s</span>
<span class="go"> =&gt; =&gt; sha256:efebc2e683d297ae71acae9230d17af8b95684d9a4f9b7f601a8e1e9b1 3.11MB / 3.11MB  1.5s</span>
<span class="go"> =&gt; =&gt; extracting sha256:66e1d5e70e420aa86a23bd8b4eebf2a6eb60b4aff9ee8a6ca52e27f51f57b1b  0.2s</span>
<span class="go"> =&gt; =&gt; extracting sha256:0448660c92fc1b6557cf48081d99028eeaba7809a1c2f23018e2331f3cfe4b2  0.4s</span>
<span class="go"> =&gt; =&gt; extracting sha256:3ce23f846e315e35618c4604547bbe6aa2b48a0601c335c76b8fe02729bb5c4  0.0s</span>
<span class="go"> =&gt; =&gt; extracting sha256:efebc2e683d297ae71acae9230d17af8b95684d9a4f9b7f601a8e1e9b103bda  0.2s</span>
<span class="go"> =&gt; exporting to image                                                                    0.0s</span>
<span class="go"> =&gt; =&gt; exporting layers                                                                   0.0s</span>
<span class="go"> =&gt; =&gt; writing image sha256:caaa3b6bf89788867da2a2d8fbd3396b3486c6bf7922b2177e6c2dabd8f6  0.0s</span>
<span class="go"> =&gt; =&gt; naming to docker.io/library/hello                                                  0.0s</span>
<span class="gp">$ </span>docker<span class="w"> </span>run<span class="w"> </span>--rm<span class="w"> </span>hello:latest
<span class="go">hello</span>
</pre></div>
</div>
<p>Для получения детальной информации об образе можно воспользоваться командой
<code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">inspect</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>docker<span class="w"> </span>image<span class="w"> </span>inspect<span class="w"> </span>hello:latest
<span class="go">[</span>
<span class="go">    {</span>
<span class="go">        &quot;Id&quot;: &quot;sha256:b82039dd53d96094d9e8a5f0e5698fc26590f029b239883d931ce8a753772b71&quot;,</span>
<span class="go">        &quot;RepoTags&quot;: [</span>
<span class="go">            &quot;hello:latest&quot;</span>
<span class="go">        ],</span>
<span class="go">...</span>
</pre></div>
</div>
</section>
<section id="copy-add">
<h3>Copy/Add<a class="headerlink" href="#copy-add" title="Permalink to this heading"></a></h3>
<p>Для копирования файлов внутрь образа из контекста сборки можно воспользоваться
инструкциями <a class="reference external" href="https://docs.docker.com/engine/reference/builder/#copy"><code class="docutils literal notranslate"><span class="pre">COPY</span></code></a> и <a class="reference external" href="https://docs.docker.com/engine/reference/builder/#add"><code class="docutils literal notranslate"><span class="pre">ADD</span></code></a>. Контекст сборки указывается в команде
<code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">build</span></code> в виде пути(в нашем случае это путь <code class="docutils literal notranslate"><span class="pre">/vagrant/</span></code>.</p>
<p>Возьмем скрипт на python, который будет отвечать на HTTP запросы по порту 8888 и расположим
его рядом с <a class="reference external" href="https://docs.docker.com/engine/reference/builder/">Dockerfile</a> под именем <code class="docutils literal notranslate"><span class="pre">main.py</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="kn">from</span> <span class="nn">http.server</span> <span class="kn">import</span> <span class="n">HTTPServer</span><span class="p">,</span> <span class="n">BaseHTTPRequestHandler</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">getenv</span>

<span class="k">class</span> <span class="nc">Handler</span><span class="p">(</span><span class="n">BaseHTTPRequestHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">do_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;FILE&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;file: </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">file</span> <span class="o">!=</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

<span class="n">HTTPServer</span><span class="p">((</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">8888</span><span class="p">),</span> <span class="n">Handler</span><span class="p">)</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</pre></div>
</div>
<p>Опишем <a class="reference external" href="https://docs.docker.com/engine/reference/builder/">Dockerfile</a> следующим образом:</p>
<div class="highlight-dockerfile notranslate"><div class="highlight"><pre><span></span><span class="k">FROM</span><span class="w"> </span><span class="s">python:3.11.5-alpine</span>

<span class="k">COPY</span><span class="w"> </span>main.py<span class="w"> </span>/main.py
<span class="k">ADD</span><span class="w"> </span>https://example.com<span class="w"> </span>/example.html

<span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;python&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;main.py&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>В данном примере инструкция <code class="docutils literal notranslate"><span class="pre">COPY</span></code> скопирует файл из контекста сборки(<code class="docutils literal notranslate"><span class="pre">/vagrant/</span></code>) внутрь
образа, а <code class="docutils literal notranslate"><span class="pre">ADD</span></code> скачает файл пор заданному URL и сохранит внутри образа с именем
<code class="docutils literal notranslate"><span class="pre">example.html</span></code>. После чего мы задаем команду запуска интерпретатора python, которому
передаем на исполнение наш файл.</p>
<div class="admonition note">
<p class="admonition-title">Примечание</p>
<p>Основное отличие <code class="docutils literal notranslate"><span class="pre">COPY</span></code> от <code class="docutils literal notranslate"><span class="pre">ADD</span></code> - это возоможность <code class="docutils literal notranslate"><span class="pre">ADD</span></code> скачивать файлы по URL, а также
автоматически разархивировать tar архивы. Но рекомендуется использовать <code class="docutils literal notranslate"><span class="pre">COPY</span></code>, так у
данной директивы более очевидное поведение, а скачивание и разархивирование производить
в директивах <code class="docutils literal notranslate"><span class="pre">RUN</span></code>.</p>
</div>
<p>Соберем образ с именем <code class="docutils literal notranslate"><span class="pre">main</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>docker<span class="w"> </span>build<span class="w"> </span>-t<span class="w"> </span>main<span class="w"> </span>/vagrant/
<span class="go">[+] Building 1.6s (9/9) FINISHED                                                docker:default</span>
<span class="go"> =&gt; [internal] load build definition from Dockerfile                                      0.0s</span>
<span class="go"> =&gt; =&gt; transferring dockerfile: 151B                                                      0.0s</span>
<span class="go"> =&gt; [internal] load .dockerignore                                                         0.0s</span>
<span class="go"> =&gt; =&gt; transferring context: 2B                                                           0.0s</span>
<span class="go"> =&gt; [internal] load metadata for docker.io/library/python:3.11.5-alpine                   1.0s</span>
<span class="go"> =&gt; [internal] load build context                                                         0.0s</span>
<span class="go"> =&gt; =&gt; transferring context: 29B                                                          0.0s</span>
<span class="go"> =&gt; https://example.com                                                                   0.5s</span>
<span class="go"> =&gt; [1/3] FROM docker.io/library/python:3.11.5-alpine@sha256:5d769f990397afbb2aca24b0655  0.0s</span>
<span class="go"> =&gt; CACHED [2/3] COPY main.py /main.py                                                    0.0s</span>
<span class="go"> =&gt; CACHED [3/3] ADD https://example.com /example.html                                    0.0s</span>
<span class="go"> =&gt; exporting to image                                                                    0.0s</span>
<span class="go"> =&gt; =&gt; exporting layers                                                                   0.0s</span>
<span class="go"> =&gt; =&gt; writing image sha256:b82039dd53d96094d9e8a5f0e5698fc26590f029b239883d931ce8a75377  0.0s</span>
<span class="go"> =&gt; =&gt; naming to docker.io/library/main                                                   0.0s</span>
</pre></div>
</div>
<p>И проверим его работу:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>docker<span class="w"> </span>run<span class="w"> </span>-d<span class="w"> </span>-p<span class="w"> </span><span class="m">8888</span>:8888<span class="w"> </span>--name<span class="w"> </span>main<span class="w"> </span>main:latest
<span class="go">f74c1f74e7bc09a0797a7717c144ffa64c5412f9621c66dd7d822057375ddd65</span>
<span class="gp">$ </span>curl<span class="w"> </span>localhost:8888
<span class="go">file: none</span>
</pre></div>
</div>
<p>Как видно наше приложение запустилось и обрабатывает HTTP запросы.</p>
<p>Также в инструкция <a class="reference external" href="https://docs.docker.com/engine/reference/builder/#copy"><code class="docutils literal notranslate"><span class="pre">COPY</span></code></a> и <a class="reference external" href="https://docs.docker.com/engine/reference/builder/#add"><code class="docutils literal notranslate"><span class="pre">ADD</span></code></a> есть возможность задать права файла
внутри образа с помощью опции <code class="docutils literal notranslate"><span class="pre">--chmod</span></code> и владельца опцией <code class="docutils literal notranslate"><span class="pre">--chown</span></code>. Дадим файлу <code class="docutils literal notranslate"><span class="pre">main.py</span></code>
права на запуск, так что можно будет в <a class="reference external" href="https://docs.docker.com/engine/reference/builder/#cmd"><code class="docutils literal notranslate"><span class="pre">CMD</span></code></a> указать не интерпретатор python, а наш
исполняемый файл:</p>
<div class="highlight-dockerfile notranslate"><div class="highlight"><pre><span></span><span class="k">FROM</span><span class="w"> </span><span class="s">python:3.11.5-alpine</span>

<span class="k">COPY</span><span class="w"> </span>--chmod<span class="o">=</span><span class="m">555</span><span class="w"> </span>main.py<span class="w"> </span>/main.py
<span class="k">ADD</span><span class="w"> </span>https://example.com<span class="w"> </span>/example.html

<span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;/main.py&quot;</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>docker<span class="w"> </span>build<span class="w"> </span>-t<span class="w"> </span>main<span class="w"> </span>/vagrant/
<span class="go">[+] Building 1.5s (9/9) FINISHED                                                docker:default</span>
<span class="go"> =&gt; [internal] load .dockerignore                                                         0.0s</span>
<span class="go"> =&gt; =&gt; transferring context: 2B                                                           0.0s</span>
<span class="go"> =&gt; [internal] load build definition from Dockerfile                                      0.0s</span>
<span class="go"> =&gt; =&gt; transferring dockerfile: 154B                                                      0.0s</span>
<span class="go"> =&gt; [internal] load metadata for docker.io/library/python:3.11.5-alpine                   1.0s</span>
<span class="go"> =&gt; [internal] load build context                                                         0.0s</span>
<span class="go"> =&gt; =&gt; transferring context: 29B                                                          0.0s</span>
<span class="go"> =&gt; https://example.com                                                                   0.5s</span>
<span class="go"> =&gt; [1/3] FROM docker.io/library/python:3.11.5-alpine@sha256:5d769f990397afbb2aca24b0655  0.0s</span>
<span class="go"> =&gt; CACHED [2/3] COPY --chmod=555 main.py /main.py                                        0.0s</span>
<span class="go"> =&gt; CACHED [3/3] ADD https://example.com /example.html                                    0.0s</span>
<span class="go"> =&gt; exporting to image                                                                    0.0s</span>
<span class="go"> =&gt; =&gt; exporting layers                                                                   0.0s</span>
<span class="go"> =&gt; =&gt; writing image sha256:09368b064a4bbde6e44a79f7743bbd361d1f82ddcdf8b239f504a085997a  0.0s</span>
<span class="go"> =&gt; =&gt; naming to docker.io/library/main                                                   0.0s</span>
</pre></div>
</div>
</section>
<section id="env-arg">
<h3>Env/Arg<a class="headerlink" href="#env-arg" title="Permalink to this heading"></a></h3>
<p>Для передачи параметров во время сборки служит инструкция <a class="reference external" href="https://docs.docker.com/engine/reference/builder/#arg"><code class="docutils literal notranslate"><span class="pre">ARG</span></code></a>, с помощью нее
можно задать переменные среды, которые будут существовать только на время сборки.
Если же необходимо задать переменные среды, которые будут существовать также при запуске
контейнера, то можно воспользоваться директивой <a class="reference external" href="https://docs.docker.com/engine/reference/builder/#env"><code class="docutils literal notranslate"><span class="pre">ENV</span></code></a>.</p>
<p>В данном примере мы задаем переменную <code class="docutils literal notranslate"><span class="pre">FILE</span></code> как аргумент сборки, а также передаем во
время сборки в инструкцию <a class="reference external" href="https://docs.docker.com/engine/reference/builder/#env"><code class="docutils literal notranslate"><span class="pre">ENV</span></code></a>, чтобы данная переменная была доступна также и после
сборки во время запуска контейнера:</p>
<div class="highlight-dockerfile notranslate"><div class="highlight"><pre><span></span><span class="k">FROM</span><span class="w"> </span><span class="s">python:3.11.5-alpine</span>

<span class="k">ARG</span><span class="w"> </span>FILE
<span class="k">ENV</span><span class="w"> </span><span class="nv">FILE</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">FILE</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="k">COPY</span><span class="w"> </span>--chmod<span class="o">=</span><span class="m">555</span><span class="w"> </span>main.py<span class="w"> </span>/main.py
<span class="k">ADD</span><span class="w"> </span>https://example.com<span class="w"> </span>/example.html

<span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;/main.py&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>Передача аргументов при запуске сборки осуществляется опцией <code class="docutils literal notranslate"><span class="pre">--build-arg</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>docker<span class="w"> </span>build<span class="w"> </span>-t<span class="w"> </span>main<span class="w"> </span>--build-arg<span class="w"> </span><span class="nv">FILE</span><span class="o">=</span>/example.html<span class="w"> </span>/vagrant/
<span class="go">[+] Building 0.7s (9/9) FINISHED                                                docker:default</span>
<span class="go"> =&gt; [internal] load build definition from Dockerfile                                      0.0s</span>
<span class="go"> =&gt; =&gt; transferring dockerfile: 185B                                                      0.0s</span>
<span class="go"> =&gt; [internal] load .dockerignore                                                         0.0s</span>
<span class="go"> =&gt; =&gt; transferring context: 2B                                                           0.0s</span>
<span class="go"> =&gt; [internal] load metadata for docker.io/library/python:3.11.5-alpine                   0.5s</span>
<span class="go"> =&gt; [internal] load build context                                                         0.0s</span>
<span class="go"> =&gt; =&gt; transferring context: 29B                                                          0.0s</span>
<span class="go"> =&gt; https://example.com                                                                   0.1s</span>
<span class="go"> =&gt; [1/3] FROM docker.io/library/python:3.11.5-alpine@sha256:5d769f990397afbb2aca24b0655  0.0s</span>
<span class="go"> =&gt; CACHED [2/3] COPY --chmod=555 main.py /main.py                                        0.0s</span>
<span class="go"> =&gt; CACHED [3/3] ADD https://example.com /example.html                                    0.0s</span>
<span class="go"> =&gt; exporting to image                                                                    0.0s</span>
<span class="go"> =&gt; =&gt; exporting layers                                                                   0.0s</span>
<span class="go"> =&gt; =&gt; writing image sha256:e90a9bec6dacd27430cd93793704b5f1c7abcd668232d19cdbf94ec60a05  0.0s</span>
<span class="go"> =&gt; =&gt; naming to docker.io/library/main                                                   0.0s</span>
<span class="gp">$ </span>docker<span class="w"> </span>rm<span class="w"> </span>-f<span class="w"> </span>main
<span class="go">main</span>
<span class="gp">$ </span>docker<span class="w"> </span>run<span class="w"> </span>-d<span class="w"> </span>-p<span class="w"> </span><span class="m">8888</span>:8888<span class="w"> </span>--name<span class="w"> </span>main<span class="w"> </span>main:latest
<span class="go">c5e2af35ebb1fa9c5df54a6c4e699a8e8944df3ae0b22b587d79e5a3deb78fcc</span>
<span class="gp">$ </span>curl<span class="w"> </span>-s<span class="w"> </span>localhost:8888<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>title
<span class="go">    &lt;title&gt;Example Domain&lt;/title&gt;</span>
</pre></div>
</div>
</section>
<section id="run">
<h3>Run<a class="headerlink" href="#run" title="Permalink to this heading"></a></h3>
<p>Для запуска команд внутри образа во время сборки есть инструкция <a class="reference external" href="https://docs.docker.com/engine/reference/builder/#run"><code class="docutils literal notranslate"><span class="pre">RUN</span></code></a>.
С помощью нее вы можете подготовить образ используя утилиты, которые находятся
в базовом образе. Перепишем файл <code class="docutils literal notranslate"><span class="pre">main.py</span></code> с использованием внешних зависимостей, которые
необходимо будет установить во время сборки:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">getenv</span>
<span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">FastAPI</span>
<span class="kn">from</span> <span class="nn">fastapi.responses</span> <span class="kn">import</span> <span class="n">HTMLResponse</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">response_class</span><span class="o">=</span><span class="n">HTMLResponse</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">read_example</span><span class="p">():</span>
    <span class="n">file</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;FILE&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;file: </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">file</span> <span class="o">!=</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">+=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ret</span>
</pre></div>
</div>
<p>Соответственно <a class="reference external" href="https://docs.docker.com/engine/reference/builder/">Dockerfile</a> может выглядеть так:</p>
<div class="highlight-dockerfile notranslate"><div class="highlight"><pre><span></span><span class="k">FROM</span><span class="w"> </span><span class="s">python:3.11.5-alpine</span>

<span class="k">ENV</span><span class="w"> </span><span class="nv">FILE</span><span class="o">=</span><span class="s2">&quot;/example.html&quot;</span>

<span class="k">COPY</span><span class="w"> </span>main.py<span class="w"> </span>.
<span class="k">ADD</span><span class="w"> </span>https://example.com<span class="w"> </span><span class="si">${</span><span class="nv">FILE</span><span class="si">}</span>
<span class="k">RUN</span><span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>fastapi<span class="w"> </span><span class="s2">&quot;uvicorn[standard]&quot;</span>

<span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;uvicorn&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;main:app&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;--host=0.0.0.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;--port=8888&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>Соберем и проверим:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>docker<span class="w"> </span>build<span class="w"> </span>-t<span class="w"> </span>main<span class="w"> </span>/vagrant/
<span class="go">[+] Building 10.8s (10/10) FINISHED                                             docker:default</span>
<span class="go"> =&gt; [internal] load build definition from Dockerfile                                      0.0s</span>
<span class="go"> =&gt; =&gt; transferring dockerfile: 245B                                                      0.0s</span>
<span class="go"> =&gt; [internal] load .dockerignore                                                         0.0s</span>
<span class="go"> =&gt; =&gt; transferring context: 2B                                                           0.0s</span>
<span class="go"> =&gt; [internal] load metadata for docker.io/library/python:3.11.5-alpine                   0.9s</span>
<span class="go"> =&gt; [internal] load build context                                                         0.0s</span>
<span class="go"> =&gt; =&gt; transferring context: 29B                                                          0.0s</span>
<span class="go"> =&gt; CACHED [1/4] FROM docker.io/library/python:3.11.5-alpine@sha256:5d769f990397afbb2aca  0.0s</span>
<span class="go"> =&gt; CACHED https://example.com                                                            0.5s</span>
<span class="go"> =&gt; [2/4] COPY main.py .                                                                  0.0s</span>
<span class="go"> =&gt; [3/4] ADD https://example.com /example.html                                           0.0s</span>
<span class="go"> =&gt; [4/4] RUN pip install fastapi &quot;uvicorn[standard]&quot;                                     8.8s</span>
<span class="go"> =&gt; exporting to image                                                                    0.6s</span>
<span class="go"> =&gt; =&gt; exporting layers                                                                   0.6s</span>
<span class="go"> =&gt; =&gt; writing image sha256:a872628e15170dc4f697d8c403387f4f29ae495f11365f7343c5c008b552  0.0s</span>
<span class="go"> =&gt; =&gt; naming to docker.io/library/main                                                   0.0s</span>
<span class="gp">$ </span>docker<span class="w"> </span>rm<span class="w"> </span>-f<span class="w"> </span>main
<span class="go">main</span>
<span class="gp">$ </span>docker<span class="w"> </span>run<span class="w"> </span>-d<span class="w"> </span>-p<span class="w"> </span><span class="m">8888</span>:8888<span class="w"> </span>--name<span class="w"> </span>main<span class="w"> </span>main:latest
<span class="go">959fb49fe6eb777f76279ee9e779c09f3d01ff94a9a505ddc8186e559fc4ed2d</span>
<span class="gp">$ </span>curl<span class="w"> </span>-s<span class="w"> </span>localhost:8888<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-5
<span class="go">file: /example.html</span>
<span class="go">&lt;!doctype html&gt;</span>
<span class="go">&lt;html&gt;</span>
<span class="go">&lt;head&gt;</span>
<span class="go">    &lt;title&gt;Example Domain&lt;/title&gt;</span>
</pre></div>
</div>
</section>
<section id="cache">
<h3>Cache<a class="headerlink" href="#cache" title="Permalink to this heading"></a></h3>
<p>Так как docker в процессе сборки кэширует слои, то важна последовательность сборки.
При изменении вышележащего слоя потребуется пересборка всех последующих. Если изменится
файл <code class="docutils literal notranslate"><span class="pre">main.py</span></code>, то потребуется заново скачать и установить зависимости:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">echo</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>/vagrant/main.py
<span class="gp">$ </span>docker<span class="w"> </span>build<span class="w"> </span>-t<span class="w"> </span>main<span class="w"> </span>/vagrant/
<span class="go">[+] Building 11.2s (10/10) FINISHED                                             docker:default</span>
<span class="go"> =&gt; [internal] load build definition from Dockerfile                                      0.0s</span>
<span class="go"> =&gt; =&gt; transferring dockerfile: 245B                                                      0.0s</span>
<span class="go"> =&gt; [internal] load .dockerignore                                                         0.0s</span>
<span class="go"> =&gt; =&gt; transferring context: 2B                                                           0.0s</span>
<span class="go"> =&gt; [internal] load metadata for docker.io/library/python:3.11.5-alpine                   0.4s</span>
<span class="go"> =&gt; [internal] load build context                                                         0.0s</span>
<span class="go"> =&gt; =&gt; transferring context: 381B                                                         0.0s</span>
<span class="go"> =&gt; CACHED https://example.com                                                            1.4s</span>
<span class="go"> =&gt; CACHED [1/4] FROM docker.io/library/python:3.11.5-alpine@sha256:5d769f990397afbb2aca  0.0s</span>
<span class="go"> =&gt; [2/4] COPY main.py .                                                                  0.0s</span>
<span class="go"> =&gt; [3/4] ADD https://example.com /example.html                                           0.0s</span>
<span class="go"> =&gt; [4/4] RUN pip install fastapi &quot;uvicorn[standard]&quot;                                     8.8s</span>
<span class="go"> =&gt; exporting to image                                                                    0.5s</span>
<span class="go"> =&gt; =&gt; exporting layers                                                                   0.5s</span>
<span class="go"> =&gt; =&gt; writing image sha256:b0d51dd802f65df529cded6d35e920b2cd58e99d9248c132443b79c6777b  0.0s</span>
<span class="go"> =&gt; =&gt; naming to docker.io/library/main                                                   0.0s</span>
</pre></div>
</div>
<p>Зададим установку зависимостей в нижележащем слое в <a class="reference external" href="https://docs.docker.com/engine/reference/builder/">Dockerfile</a>:</p>
<div class="highlight-dockerfile notranslate"><div class="highlight"><pre><span></span><span class="k">FROM</span><span class="w"> </span><span class="s">python:3.11.5-alpine</span>

<span class="k">ENV</span><span class="w"> </span><span class="nv">FILE</span><span class="o">=</span><span class="s2">&quot;/example.html&quot;</span>

<span class="k">RUN</span><span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>fastapi<span class="w"> </span><span class="s2">&quot;uvicorn[standard]&quot;</span>
<span class="k">COPY</span><span class="w"> </span>main.py<span class="w"> </span>.
<span class="k">ADD</span><span class="w"> </span>https://example.com<span class="w"> </span><span class="si">${</span><span class="nv">FILE</span><span class="si">}</span>

<span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;uvicorn&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;main:app&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;--host=0.0.0.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;--port=8888&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>Теперь последующие сборки не потребуют выполнять скачивание и установку зависимостей,
что значительно ускорит их время выполнения:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>docker<span class="w"> </span>build<span class="w"> </span>-t<span class="w"> </span>main<span class="w"> </span>/vagrant/
<span class="go">[+] Building 1.0s (10/10) FINISHED                                              docker:default</span>
<span class="go"> =&gt; [internal] load build definition from Dockerfile                                      0.0s</span>
<span class="go"> =&gt; =&gt; transferring dockerfile: 245B                                                      0.0s</span>
<span class="go"> =&gt; [internal] load .dockerignore                                                         0.0s</span>
<span class="go"> =&gt; =&gt; transferring context: 2B                                                           0.0s</span>
<span class="go"> =&gt; [internal] load metadata for docker.io/library/python:3.11.5-alpine                   0.5s</span>
<span class="go"> =&gt; [1/4] FROM docker.io/library/python:3.11.5-alpine@sha256:5d769f990397afbb2aca24b0655  0.0s</span>
<span class="go"> =&gt; CACHED https://example.com                                                            0.5s</span>
<span class="go"> =&gt; [internal] load build context                                                         0.0s</span>
<span class="go"> =&gt; =&gt; transferring context: 29B                                                          0.0s</span>
<span class="go"> =&gt; CACHED [2/4] RUN pip install fastapi &quot;uvicorn[standard]&quot;                              0.0s</span>
<span class="go"> =&gt; [3/4] COPY main.py .                                                                  0.0s</span>
<span class="go"> =&gt; [4/4] ADD https://example.com /example.html                                           0.0s</span>
<span class="go"> =&gt; exporting to image                                                                    0.0s</span>
<span class="go"> =&gt; =&gt; exporting layers                                                                   0.0s</span>
<span class="go"> =&gt; =&gt; writing image sha256:4cf84d3406df7701d0c143deb30c913e4d88f68353740e03684c3056e83d  0.0s</span>
<span class="go"> =&gt; =&gt; naming to docker.io/library/main                                                   0.0s</span>
<span class="gp">$ </span><span class="nb">echo</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>/vagrant/main.py
<span class="gp">$ </span>docker<span class="w"> </span>build<span class="w"> </span>-t<span class="w"> </span>main<span class="w"> </span>/vagrant/
<span class="go">[+] Building 0.6s (10/10) FINISHED                                              docker:default</span>
<span class="go"> =&gt; [internal] load build definition from Dockerfile                                      0.0s</span>
<span class="go"> =&gt; =&gt; transferring dockerfile: 245B                                                      0.0s</span>
<span class="go"> =&gt; [internal] load .dockerignore                                                         0.0s</span>
<span class="go"> =&gt; =&gt; transferring context: 2B                                                           0.0s</span>
<span class="go"> =&gt; [internal] load metadata for docker.io/library/python:3.11.5-alpine                   0.4s</span>
<span class="go"> =&gt; [1/4] FROM docker.io/library/python:3.11.5-alpine@sha256:5d769f990397afbb2aca24b0655  0.0s</span>
<span class="go"> =&gt; [internal] load build context                                                         0.0s</span>
<span class="go"> =&gt; =&gt; transferring context: 382B                                                         0.0s</span>
<span class="go"> =&gt; CACHED https://example.com                                                            0.1s</span>
<span class="go"> =&gt; CACHED [2/4] RUN pip install fastapi &quot;uvicorn[standard]&quot;                              0.0s</span>
<span class="go"> =&gt; [3/4] COPY main.py .                                                                  0.0s</span>
<span class="go"> =&gt; [4/4] ADD https://example.com /example.html                                           0.0s</span>
<span class="go"> =&gt; exporting to image                                                                    0.0s</span>
<span class="go"> =&gt; =&gt; exporting layers                                                                   0.0s</span>
<span class="go"> =&gt; =&gt; writing image sha256:0657e4aef1a267c34f131d0c3e26b82823abd18db063c24b623201edd8b0  0.0s</span>
<span class="go"> =&gt; =&gt; naming to docker.io/library/main                                                   0.0s</span>
</pre></div>
</div>
</section>
<section id="expose">
<h3>Expose<a class="headerlink" href="#expose" title="Permalink to this heading"></a></h3>
<p>Для указания портов, которые могут использоваться для подключения к приложению
в контейнере используется инструкция <a class="reference external" href="https://docs.docker.com/engine/reference/builder/#expose"><code class="docutils literal notranslate"><span class="pre">EXPOSE</span></code></a>:</p>
<div class="highlight-dockerfile notranslate"><div class="highlight"><pre><span></span><span class="k">FROM</span><span class="w"> </span><span class="s">python:3.11.5-alpine</span>

<span class="k">ENV</span><span class="w"> </span><span class="nv">FILE</span><span class="o">=</span><span class="s2">&quot;/example.html&quot;</span>

<span class="k">RUN</span><span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>fastapi<span class="w"> </span><span class="s2">&quot;uvicorn[standard]&quot;</span>
<span class="k">COPY</span><span class="w"> </span>main.py<span class="w"> </span>.
<span class="k">ADD</span><span class="w"> </span>https://example.com<span class="w"> </span><span class="si">${</span><span class="nv">FILE</span><span class="si">}</span>

<span class="k">EXPOSE</span><span class="w"> </span><span class="s">8888</span>

<span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;uvicorn&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;main:app&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;--host=0.0.0.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;--port=8888&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>После сборки образа можно наблюдать выставленные порты в команде <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">image</span> <span class="pre">inspect</span></code>,
а также после запуска, если явно не задан проброс портов, в команде <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">ps</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>docker<span class="w"> </span>build<span class="w"> </span>-t<span class="w"> </span>main<span class="w"> </span>/vagrant/
<span class="go">[+] Building 1.4s (10/10) FINISHED                                              docker:default</span>
<span class="go"> =&gt; [internal] load build definition from Dockerfile                                      0.0s</span>
<span class="go"> =&gt; =&gt; transferring dockerfile: 258B                                                      0.0s</span>
<span class="go"> =&gt; [internal] load .dockerignore                                                         0.0s</span>
<span class="go"> =&gt; =&gt; transferring context: 2B                                                           0.0s</span>
<span class="go"> =&gt; [internal] load metadata for docker.io/library/python:3.11.5-alpine                   0.9s</span>
<span class="go"> =&gt; [1/4] FROM docker.io/library/python:3.11.5-alpine@sha256:5d769f990397afbb2aca24b0655  0.0s</span>
<span class="go"> =&gt; https://example.com                                                                   0.5s</span>
<span class="go"> =&gt; [internal] load build context                                                         0.0s</span>
<span class="go"> =&gt; =&gt; transferring context: 29B                                                          0.0s</span>
<span class="go"> =&gt; CACHED [2/4] RUN pip install fastapi &quot;uvicorn[standard]&quot;                              0.0s</span>
<span class="go"> =&gt; CACHED [3/4] COPY main.py .                                                           0.0s</span>
<span class="go"> =&gt; CACHED [4/4] ADD https://example.com /example.html                                    0.0s</span>
<span class="go"> =&gt; exporting to image                                                                    0.0s</span>
<span class="go"> =&gt; =&gt; exporting layers                                                                   0.0s</span>
<span class="go"> =&gt; =&gt; writing image sha256:c34234caa5431df50019ca07f4072639dcfa51a737f175c2654b228706a6  0.0s</span>
<span class="go"> =&gt; =&gt; naming to docker.io/library/main                                                   0.0s</span>
<span class="gp">$ </span>docker<span class="w"> </span>image<span class="w"> </span>inspect<span class="w"> </span>main:latest<span class="w"> </span>--format<span class="o">=</span><span class="s1">&#39;{{json .Config.ExposedPorts}}&#39;</span>
<span class="go">{&quot;8888/tcp&quot;:{}}</span>
<span class="gp">$ </span>docker<span class="w"> </span>rm<span class="w"> </span>-f<span class="w"> </span>main
<span class="go">main</span>
<span class="gp">$ </span>docker<span class="w"> </span>run<span class="w"> </span>-d<span class="w"> </span>--name<span class="w"> </span>main<span class="w"> </span>main:latest
<span class="go">91a4683a36bc635e4ea91531f5a9861a7d95572eb30b17883123c66c9836bd5e</span>
<span class="gp">$ </span>docker<span class="w"> </span>ps
<span class="go">CONTAINER ID   IMAGE         COMMAND                  CREATED         STATUS         PORTS      NAMES</span>
<span class="go">91a4683a36bc   main:latest   &quot;uvicorn main:app --…&quot;   5 seconds ago   Up 4 seconds   8888/tcp   main</span>
</pre></div>
</div>
</section>
<section id="label">
<h3>Label<a class="headerlink" href="#label" title="Permalink to this heading"></a></h3>
<p>С помощью инструкции <a class="reference external" href="https://docs.docker.com/engine/reference/builder/#label"><code class="docutils literal notranslate"><span class="pre">LABEL</span></code></a> можно добавить метаданные в образ в виде
<code class="docutils literal notranslate"><span class="pre">&lt;key&gt;=&lt;value&gt;</span></code>, которые могут служить как дополнительная информация об образе или
использоваться каким-либо способом в сборочных конвейерах:</p>
<div class="highlight-dockerfile notranslate"><div class="highlight"><pre><span></span><span class="k">FROM</span><span class="w"> </span><span class="s">python:3.11.5-alpine</span>

<span class="k">ENV</span><span class="w"> </span><span class="nv">FILE</span><span class="o">=</span><span class="s2">&quot;/example.html&quot;</span>

<span class="k">RUN</span><span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>fastapi<span class="w"> </span><span class="s2">&quot;uvicorn[standard]&quot;</span>
<span class="k">COPY</span><span class="w"> </span>main.py<span class="w"> </span>.
<span class="k">ADD</span><span class="w"> </span>https://example.com<span class="w"> </span><span class="si">${</span><span class="nv">FILE</span><span class="si">}</span>

<span class="k">EXPOSE</span><span class="w"> </span><span class="s">8888</span>

<span class="k">LABEL</span><span class="w"> </span><span class="nv">version</span><span class="o">=</span><span class="s2">&quot;0.1&quot;</span>

<span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;uvicorn&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;main:app&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;--host=0.0.0.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;--port=8888&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>После сборки значения директив <a class="reference external" href="https://docs.docker.com/engine/reference/builder/#label"><code class="docutils literal notranslate"><span class="pre">LABEL</span></code></a> можно также посмотреть командой
<code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">image</span> <span class="pre">inspect</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>docker<span class="w"> </span>build<span class="w"> </span>-t<span class="w"> </span>main<span class="w"> </span>/vagrant/
<span class="go">[+] Building 1.4s (10/10) FINISHED                                              docker:default</span>
<span class="go"> =&gt; [internal] load build definition from Dockerfile                                      0.0s</span>
<span class="go"> =&gt; =&gt; transferring dockerfile: 279B                                                      0.0s</span>
<span class="go"> =&gt; [internal] load .dockerignore                                                         0.0s</span>
<span class="go"> =&gt; =&gt; transferring context: 2B                                                           0.0s</span>
<span class="go"> =&gt; [internal] load metadata for docker.io/library/python:3.11.5-alpine                   0.9s</span>
<span class="go"> =&gt; [1/4] FROM docker.io/library/python:3.11.5-alpine@sha256:5d769f990397afbb2aca24b0655  0.0s</span>
<span class="go"> =&gt; https://example.com                                                                   0.5s</span>
<span class="go"> =&gt; [internal] load build context                                                         0.0s</span>
<span class="go"> =&gt; =&gt; transferring context: 29B                                                          0.0s</span>
<span class="go"> =&gt; CACHED [2/4] RUN pip install fastapi &quot;uvicorn[standard]&quot;                              0.0s</span>
<span class="go"> =&gt; CACHED [3/4] COPY main.py .                                                           0.0s</span>
<span class="go"> =&gt; CACHED [4/4] ADD https://example.com /example.html                                    0.0s</span>
<span class="go"> =&gt; exporting to image                                                                    0.0s</span>
<span class="go"> =&gt; =&gt; exporting layers                                                                   0.0s</span>
<span class="go"> =&gt; =&gt; writing image sha256:f08ac61ac1576278ff220148791ae1fe212c60aa2efd0cb70e725f708f2a  0.0s</span>
<span class="go"> =&gt; =&gt; naming to docker.io/library/main                                                   0.0s</span>
<span class="gp">$ </span>docker<span class="w"> </span>image<span class="w"> </span>inspect<span class="w"> </span>main:latest<span class="w"> </span>--format<span class="o">=</span><span class="s1">&#39;{{json .Config.Labels}}&#39;</span>
<span class="go">{&quot;version&quot;:&quot;0.1&quot;}</span>
</pre></div>
</div>
</section>
<section id="cmd-entrypoint">
<h3>Cmd/Entrypoint<a class="headerlink" href="#cmd-entrypoint" title="Permalink to this heading"></a></h3>
<p>Для указания команды, которая будет запускаться при старте контейнера есть две директивы:
<a class="reference external" href="https://docs.docker.com/engine/reference/builder/#cmd"><code class="docutils literal notranslate"><span class="pre">CMD</span></code></a> и <a class="reference external" href="https://docs.docker.com/engine/reference/builder/#entrypoint"><code class="docutils literal notranslate"><span class="pre">ENTRYPOINT</span></code></a>. Если в <a class="reference external" href="https://docs.docker.com/engine/reference/builder/">Dockerfile</a> указана только одна из
них, то она и будет определять команду запуска. Если же указаны обе, то команда запуска
будет строиться сначала из параметров в <a class="reference external" href="https://docs.docker.com/engine/reference/builder/#entrypoint"><code class="docutils literal notranslate"><span class="pre">ENTRYPOINT</span></code></a>, затем из параметров
в <a class="reference external" href="https://docs.docker.com/engine/reference/builder/#cmd"><code class="docutils literal notranslate"><span class="pre">CMD</span></code></a>. <a class="reference external" href="https://docs.docker.com/engine/reference/builder/#understand-how-cmd-and-entrypoint-interact">Подробнее о их взаимодействии можно почитать в документации.</a></p>
<p>Разделим команду запуска на две инструкции:</p>
<div class="highlight-dockerfile notranslate"><div class="highlight"><pre><span></span><span class="k">FROM</span><span class="w"> </span><span class="s">python:3.11.5-alpine</span>

<span class="k">ENV</span><span class="w"> </span><span class="nv">FILE</span><span class="o">=</span><span class="s2">&quot;/example.html&quot;</span>

<span class="k">RUN</span><span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>fastapi<span class="w"> </span><span class="s2">&quot;uvicorn[standard]&quot;</span>
<span class="k">COPY</span><span class="w"> </span>main.py<span class="w"> </span>.
<span class="k">ADD</span><span class="w"> </span>https://example.com<span class="w"> </span><span class="si">${</span><span class="nv">FILE</span><span class="si">}</span>

<span class="k">EXPOSE</span><span class="w"> </span><span class="s">8888</span>

<span class="k">LABEL</span><span class="w"> </span><span class="nv">version</span><span class="o">=</span><span class="s2">&quot;0.1&quot;</span>

<span class="k">ENTRYPOINT</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;uvicorn&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;main:app&quot;</span><span class="p">]</span>
<span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;--host=0.0.0.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;--port=8888&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>После сборки можно убедиться, что контейнер функционирует как обычно:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>docker<span class="w"> </span>build<span class="w"> </span>-t<span class="w"> </span>main<span class="w"> </span>/vagrant/
<span class="go">[+] Building 1.6s (10/10) FINISHED                                             docker:default</span>
<span class="go"> =&gt; [internal] load build definition from Dockerfile                                     0.0s</span>
<span class="go"> =&gt; =&gt; transferring dockerfile: 291B                                                     0.0s</span>
<span class="go"> =&gt; [internal] load .dockerignore                                                        0.0s</span>
<span class="go"> =&gt; =&gt; transferring context: 2B                                                          0.0s</span>
<span class="go"> =&gt; [internal] load metadata for docker.io/library/python:3.11.5-alpine                  1.1s</span>
<span class="go"> =&gt; [1/4] FROM docker.io/library/python:3.11.5-alpine@sha256:5d769f990397afbb2aca24b065  0.0s</span>
<span class="go"> =&gt; https://example.com                                                                  0.5s</span>
<span class="go"> =&gt; [internal] load build context                                                        0.0s</span>
<span class="go"> =&gt; =&gt; transferring context: 29B                                                         0.0s</span>
<span class="go"> =&gt; CACHED [2/4] RUN pip install fastapi &quot;uvicorn[standard]&quot;                             0.0s</span>
<span class="go"> =&gt; CACHED [3/4] COPY main.py .                                                          0.0s</span>
<span class="go"> =&gt; CACHED [4/4] ADD https://example.com /example.html                                   0.0s</span>
<span class="go"> =&gt; exporting to image                                                                   0.0s</span>
<span class="go"> =&gt; =&gt; exporting layers                                                                  0.0s</span>
<span class="go"> =&gt; =&gt; writing image sha256:c5e6676b703a475f3a09b547771d7d8afb8df158f92bee7b2734dc717f6  0.0s</span>
<span class="go"> =&gt; =&gt; naming to docker.io/library/main                                                  0.0s</span>
<span class="gp">$ </span>docker<span class="w"> </span>rm<span class="w"> </span>-f<span class="w"> </span>main
<span class="go">main</span>
<span class="gp">$ </span>docker<span class="w"> </span>run<span class="w"> </span>-d<span class="w"> </span>-p<span class="w"> </span><span class="m">8888</span>:8888<span class="w"> </span>--name<span class="w"> </span>main<span class="w"> </span>main:latest
<span class="go">9e7f7d23812ed19f077e9ac29eff54e57b4efbcfa67b8b311acced68254a2ce7</span>
<span class="gp">$ </span>curl<span class="w"> </span>-s<span class="w"> </span>localhost:8888<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-5
<span class="go">file: /example.html</span>
<span class="go">&lt;!doctype html&gt;</span>
<span class="go">&lt;html&gt;</span>
<span class="go">&lt;head&gt;</span>
<span class="go">    &lt;title&gt;Example Domain&lt;/title&gt;</span>
</pre></div>
</div>
<p>Теперь же мы можем переопределить параметры в <a class="reference external" href="https://docs.docker.com/engine/reference/builder/#cmd"><code class="docutils literal notranslate"><span class="pre">CMD</span></code></a>, указав их при запуске
контейнера в конце команды <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">run</span></code>, а также <a class="reference external" href="https://docs.docker.com/engine/reference/builder/#entrypoint"><code class="docutils literal notranslate"><span class="pre">ENTRYPOINT</span></code></a> опцией
<code class="docutils literal notranslate"><span class="pre">--entrypoint</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>docker<span class="w"> </span>rm<span class="w"> </span>-f<span class="w"> </span>main
<span class="go">main</span>
<span class="gp">$ </span>docker<span class="w"> </span>run<span class="w"> </span>-d<span class="w"> </span>-p<span class="w"> </span><span class="m">8889</span>:8889<span class="w"> </span>--name<span class="w"> </span>main<span class="w"> </span>main:latest<span class="w"> </span>--host<span class="o">=</span><span class="m">0</span>.0.0.0<span class="w"> </span>--port<span class="o">=</span><span class="m">8889</span>
<span class="go">acbc469c530e7c7fcc2e7e0032e2e84000a6dac38c4a82014002e7f5fcaf2806</span>
<span class="gp">$ </span>curl<span class="w"> </span>-s<span class="w"> </span>localhost:8889<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-5
<span class="go">file: /example.html</span>
<span class="go">&lt;!doctype html&gt;</span>
<span class="go">&lt;html&gt;</span>
<span class="go">&lt;head&gt;</span>
<span class="go">    &lt;title&gt;Example Domain&lt;/title&gt;</span>
<span class="gp">$ </span>docker<span class="w"> </span>rm<span class="w"> </span>-f<span class="w"> </span>main
<span class="go">main</span>
<span class="gp">$ </span>docker<span class="w"> </span>run<span class="w"> </span>--rm<span class="w"> </span>--name<span class="w"> </span>main<span class="w"> </span>--entrypoint<span class="w"> </span><span class="nb">echo</span><span class="w"> </span>main:latest<span class="w"> </span>hello
<span class="go">hello</span>
</pre></div>
</div>
</section>
<section id="multi-stage">
<h3>Multi-Stage<a class="headerlink" href="#multi-stage" title="Permalink to this heading"></a></h3>
<p>Docker позволяет производить <a class="reference external" href="https://docs.docker.com/build/building/multi-stage/">multi-stage</a> сборки, которые позволяют оптимизировать
результирующий образ, вложив в него только необходимое для запуска приложения, а
зависимости, необходимые для сборки приложения, иметь в отдельном стейдже только на
время сборки.</p>
<p>Возьмем <a class="reference external" href="https://docs.docker.com/engine/reference/builder/">Dockerfile</a> со следующим содержимым:</p>
<div class="highlight-dockerfile notranslate"><div class="highlight"><pre><span></span><span class="k">FROM</span><span class="w"> </span><span class="s">golang:1.21</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s">build</span>
<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/src</span>
<span class="k">COPY</span><span class="w"> </span>&lt;&lt;EOF<span class="w"> </span>/src/main.go
package<span class="w"> </span>main

import<span class="w"> </span><span class="s2">&quot;fmt&quot;</span>

func<span class="w"> </span>main<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span>fmt.Println<span class="o">(</span><span class="s2">&quot;hello, world&quot;</span><span class="o">)</span>
<span class="o">}</span>
EOF
<span class="k">RUN</span><span class="w"> </span>go<span class="w"> </span>build<span class="w"> </span>-o<span class="w"> </span>/bin/hello<span class="w"> </span>./main.go

<span class="k">FROM</span><span class="w"> </span><span class="s">scratch</span>
<span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>build<span class="w"> </span>/bin/hello<span class="w"> </span>/bin/hello
<span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;/bin/hello&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>В данном примере сборка образа происходит на основе базового образа <code class="docutils literal notranslate"><span class="pre">golang:1.21</span></code>, а
после итоговый бинарный файл копируется в пустой образ <code class="docutils literal notranslate"><span class="pre">FROM</span> <span class="pre">scratch</span></code>.</p>
<p>Соберем образ и запустим:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>docker<span class="w"> </span>build<span class="w"> </span>-t<span class="w"> </span>hello<span class="w"> </span>/vagrant/
<span class="go">[+] Building 38.5s (10/10) FINISHED                                            docker:default</span>
<span class="go"> =&gt; [internal] load build definition from Dockerfile                                     0.0s</span>
<span class="go"> =&gt; =&gt; transferring dockerfile: 290B                                                     0.0s</span>
<span class="go"> =&gt; [internal] load .dockerignore                                                        0.0s</span>
<span class="go"> =&gt; =&gt; transferring context: 2B                                                          0.0s</span>
<span class="go"> =&gt; [internal] load metadata for docker.io/library/golang:1.21                           0.4s</span>
<span class="go"> =&gt; [build 1/4] FROM docker.io/library/golang:1.21@sha256:19600fdcae402165dcdab18cb964  32.1s</span>
<span class="go"> =&gt; =&gt; resolve docker.io/library/golang:1.21@sha256:19600fdcae402165dcdab18cb9649540bde  0.0s</span>
<span class="go"> =&gt; =&gt; sha256:19600fdcae402165dcdab18cb9649540bde6be7274dedb5d205b2f840 2.36kB / 2.36kB  0.0s</span>
<span class="go"> =&gt; =&gt; sha256:b47a222d28fa95680198398973d0a29b82a968f03e7ef361cc8ded5 24.03MB / 24.03MB  8.0s</span>
<span class="go"> =&gt; =&gt; sha256:debce5f9f3a9709885f7f2ad3cf41f036a3b57b406b27ba3a88392 64.11MB / 64.11MB  13.5s</span>
<span class="go"> =&gt; =&gt; sha256:b17c35044f4062d83c815434615997eed97697daae8745c6dd39dc367 1.58kB / 1.58kB  0.0s</span>
<span class="go"> =&gt; =&gt; sha256:2159148dcc081245165b2aa99fc5a94ca9818bece66839d8eb11c9335 7.22kB / 7.22kB  0.0s</span>
<span class="go"> =&gt; =&gt; sha256:167b8a53ca4504bc6aa3182e336fa96f4ef76875d158c1933d3e2f 49.56MB / 49.56MB  12.2s</span>
<span class="go"> =&gt; =&gt; sha256:91b457aaf04f424db4f223ea7aad4b196d4a62da58d6f45938233e 92.30MB / 92.30MB  25.0s</span>
<span class="go"> =&gt; =&gt; extracting sha256:167b8a53ca4504bc6aa3182e336fa96f4ef76875d158c1933d3e2fa19c57e0  2.3s</span>
<span class="go"> =&gt; =&gt; sha256:b0ed6cc9b50977796e8eb9b270ad9c62922003c0090aa3e5ec26a1 66.99MB / 66.99MB  24.6s</span>
<span class="go"> =&gt; =&gt; sha256:92b30a24413a45c9744b79bafa4c7717eafff586a9332210abbd384f7778 155B / 155B  13.7s</span>
<span class="go"> =&gt; =&gt; extracting sha256:b47a222d28fa95680198398973d0a29b82a968f03e7ef361cc8ded562e4d84  0.7s</span>
<span class="go"> =&gt; =&gt; extracting sha256:debce5f9f3a9709885f7f2ad3cf41f036a3b57b406b27ba3a8839283157870  2.9s</span>
<span class="go"> =&gt; =&gt; extracting sha256:91b457aaf04f424db4f223ea7aad4b196d4a62da58d6f45938233e0f54bd16  2.5s</span>
<span class="go"> =&gt; =&gt; extracting sha256:b0ed6cc9b50977796e8eb9b270ad9c62922003c0090aa3e5ec26a165cfcb9c  4.3s</span>
<span class="go"> =&gt; =&gt; extracting sha256:92b30a24413a45c9744b79bafa4c7717eafff586a9332210abbd384f77785d  0.0s</span>
<span class="go"> =&gt; [internal] preparing inline document                                                 0.0s</span>
<span class="go"> =&gt; [build 2/4] WORKDIR /src                                                             0.1s</span>
<span class="go"> =&gt; [build 3/4] COPY &lt;&lt;EOF /src/main.go                                                  0.0s</span>
<span class="go"> =&gt; [build 4/4] RUN go build -o /bin/hello ./main.go                                     5.6s</span>
<span class="go"> =&gt; [stage-1 1/1] COPY --from=build /bin/hello /bin/hello                                0.0s</span>
<span class="go"> =&gt; exporting to image                                                                   0.0s</span>
<span class="go"> =&gt; =&gt; exporting layers                                                                  0.0s</span>
<span class="go"> =&gt; =&gt; writing image sha256:643d97e6291d22876100fff8e6edc90eccd8b045011cd8a4aa95524d8d5  0.0s</span>
<span class="go"> =&gt; =&gt; naming to docker.io/library/hello                                                 0.0s</span>
<span class="gp">$ </span>docker<span class="w"> </span>run<span class="w"> </span>--rm<span class="w"> </span>hello:latest
<span class="go">hello, world</span>
</pre></div>
</div>
<p>После сборки можно увидеть, что итоговый образ состоит из одного слоя, а его размер
менее двух мегабайт:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>docker<span class="w"> </span>image<span class="w"> </span>inspect<span class="w"> </span>hello:latest<span class="w"> </span>--format<span class="o">=</span><span class="s1">&#39;{{json .RootFS}}&#39;</span>
<span class="go">{&quot;Type&quot;:&quot;layers&quot;,&quot;Layers&quot;:[&quot;sha256:ce0d1c9c6c2209b264099514fad8f2d036136f31628db20370847bc3fcd68393&quot;]}</span>
<span class="gp">$ </span>docker<span class="w"> </span>images<span class="w"> </span>hello
<span class="go">REPOSITORY   TAG       IMAGE ID       CREATED              SIZE</span>
<span class="go">hello        latest    643d97e6291d   About a minute ago   1.8MB</span>
</pre></div>
</div>
</section>
</section>
<section id="registry">
<h2>Registry<a class="headerlink" href="#registry" title="Permalink to this heading"></a></h2>
<p>Для хранения образов обычно используется специальный реестр(registry), с которым docker
клиент может взаимодействовать по http протоколу и который имеет свое <a class="reference external" href="https://docs.docker.com/registry/spec/api/">API</a>. По-умолчанию
docker клиент использует публичный реестр <a class="reference external" href="https://hub.docker.com/">hub.docker.com</a>.</p>
<section id="id1">
<h3>Run<a class="headerlink" href="#id1" title="Permalink to this heading"></a></h3>
<p>Поднимем свой локальный реестр из образа <code class="docutils literal notranslate"><span class="pre">registry:2</span></code>, который по-умолчанию
слушает порт 5000:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>docker<span class="w"> </span>run<span class="w"> </span>-d<span class="w"> </span>-p<span class="w"> </span><span class="m">5000</span>:5000<span class="w"> </span>--name<span class="w"> </span>registry<span class="w"> </span>registry:2
<span class="go">Unable to find image &#39;registry:2&#39; locally</span>
<span class="go">2: Pulling from library/registry</span>
<span class="go">7264a8db6415: Already exists</span>
<span class="go">c4d48a809fc2: Pull complete</span>
<span class="go">88b450dec42e: Pull complete</span>
<span class="go">121f958bea53: Pull complete</span>
<span class="go">7417fa3c6d92: Pull complete</span>
<span class="go">Digest: sha256:d5f2fb0940fe9371b6b026b9b66ad08d8ab7b0d56b6ee8d5c71cb9b45a374307</span>
<span class="go">Status: Downloaded newer image for registry:2</span>
<span class="go">6d6ce64e7f7302e287fe4e8325f48adc4c939b6e91400318c52528ceceefad09</span>
</pre></div>
</div>
<p>Проверить его работоспособность можно командой <code class="docutils literal notranslate"><span class="pre">curl</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>curl<span class="w"> </span>localhost:5000/v2/
<span class="go">{}</span>
</pre></div>
</div>
</section>
<section id="push">
<h3>Push<a class="headerlink" href="#push" title="Permalink to this heading"></a></h3>
<p>Для отправки образа в registry необходимо задать ему имя, в котором будет указание на
конкретный registry. Для этого можно воспользоваться командой <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">tag</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>docker<span class="w"> </span>tag<span class="w"> </span>hello:latest<span class="w"> </span>localhost:5000/hello<span class="w"> </span><span class="c1"># без указания тега будет использован latest</span>
<span class="gp">$ </span>docker<span class="w"> </span>tag<span class="w"> </span>hello:latest<span class="w"> </span>localhost:5000/hello:0.1<span class="w"> </span><span class="c1"># можно указать тег явно</span>
<span class="gp">$ </span>docker<span class="w"> </span>tag<span class="w"> </span>main:latest<span class="w"> </span>localhost:5000/main
<span class="gp">$ </span>docker<span class="w"> </span>tag<span class="w"> </span>main:latest<span class="w"> </span>localhost:5000/main:python3.11.5
</pre></div>
</div>
<p>После чего можно отправить образы в локальный реестр командой <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">push</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>docker<span class="w"> </span>push<span class="w"> </span>localhost:5000/hello
<span class="go">Using default tag: latest</span>
<span class="go">The push refers to repository [localhost:5000/hello]</span>
<span class="go">ce0d1c9c6c22: Pushed</span>
<span class="go">latest: digest: sha256:3f8d6a1d510560a70b02dcc9722501c15fc4a1a78e11333913b863017dde40d7 size: 527</span>
<span class="gp">$ </span>docker<span class="w"> </span>push<span class="w"> </span>localhost:5000/hello:0.1
<span class="go">The push refers to repository [localhost:5000/hello]</span>
<span class="go">ce0d1c9c6c22: Layer already exists</span>
<span class="go">0.1: digest: sha256:3f8d6a1d510560a70b02dcc9722501c15fc4a1a78e11333913b863017dde40d7 size: 527</span>
<span class="gp">$ </span>docker<span class="w"> </span>push<span class="w"> </span>localhost:5000/main
<span class="go">Using default tag: latest</span>
<span class="go">The push refers to repository [localhost:5000/main]</span>
<span class="go">18e02cddb804: Pushed</span>
<span class="go">3a5eb5dbf933: Pushed</span>
<span class="go">c4b567ddc865: Pushed</span>
<span class="go">08928985481f: Pushed</span>
<span class="go">7acf52b2a13c: Pushed</span>
<span class="go">ce0f4c80e9b7: Pushed</span>
<span class="go">9ad60c84bfbe: Pushed</span>
<span class="go">4693057ce236: Pushed</span>
<span class="go">latest: digest: sha256:4957a623702236127336a3e54a5dad314c14e411fbd3096e5f669919afa90d21 size: 1994</span>
<span class="gp">$ </span>docker<span class="w"> </span>push<span class="w"> </span>localhost:5000/main:
<span class="go">latest        python3.11.5</span>
<span class="gp">$ </span>docker<span class="w"> </span>push<span class="w"> </span>localhost:5000/main:python3.11.5
<span class="go">The push refers to repository [localhost:5000/main]</span>
<span class="go">18e02cddb804: Layer already exists</span>
<span class="go">3a5eb5dbf933: Layer already exists</span>
<span class="go">c4b567ddc865: Layer already exists</span>
<span class="go">08928985481f: Layer already exists</span>
<span class="go">7acf52b2a13c: Layer already exists</span>
<span class="go">ce0f4c80e9b7: Layer already exists</span>
<span class="go">9ad60c84bfbe: Layer already exists</span>
<span class="go">4693057ce236: Layer already exists</span>
<span class="go">python3.11.5: digest: sha256:4957a623702236127336a3e54a5dad314c14e411fbd3096e5f669919afa90d21 size: 1994</span>
</pre></div>
</div>
<p>Как видно при отправке образа, который отличается только тегом, слои не отправляются
повторно.</p>
</section>
<section id="catalog">
<h3>Catalog<a class="headerlink" href="#catalog" title="Permalink to this heading"></a></h3>
<p>Список репозиториев в реестре можно получить через <a class="reference external" href="https://docs.docker.com/registry/spec/api/">api</a>, например отправив запрос
командой <code class="docutils literal notranslate"><span class="pre">curl</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>curl<span class="w"> </span>localhost:5000/v2/_catalog
<span class="go">{&quot;repositories&quot;:[&quot;hello&quot;,&quot;main&quot;]}</span>
</pre></div>
</div>
</section>
<section id="tags-manifests">
<h3>Tags/Manifests<a class="headerlink" href="#tags-manifests" title="Permalink to this heading"></a></h3>
<p>Список тегов в каждом репозитории можно получить следующим запросом:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>curl<span class="w"> </span>localhost:5000/v2/hello/tags/list
<span class="go">{&quot;name&quot;:&quot;hello&quot;,&quot;tags&quot;:[&quot;latest&quot;,&quot;0.1&quot;]}</span>
<span class="gp">$ </span>curl<span class="w"> </span>localhost:5000/v2/main/tags/list
<span class="go">{&quot;name&quot;:&quot;main&quot;,&quot;tags&quot;:[&quot;latest&quot;,&quot;python3.11.5&quot;]}</span>
</pre></div>
</div>
<p>По тегу же можно получить манифест образа - описание состава образа в <code class="docutils literal notranslate"><span class="pre">json</span></code> формате,
конкретный манифест можно получить запросом:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>curl<span class="w"> </span>localhost:5000/v2/hello/manifests/0.1
<span class="go">{</span>
<span class="go">   &quot;schemaVersion&quot;: 1,</span>
<span class="go">   &quot;name&quot;: &quot;hello&quot;,</span>
<span class="go">   &quot;tag&quot;: &quot;0.1&quot;,</span>
<span class="go">   &quot;architecture&quot;: &quot;amd64&quot;,</span>
<span class="go">   &quot;fsLayers&quot;: [</span>
<span class="go">      {</span>
<span class="go">         &quot;blobSum&quot;: &quot;sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4&quot;</span>
<span class="go">      },</span>
<span class="go">      {</span>
<span class="go">         &quot;blobSum&quot;: &quot;sha256:e00c2c33f044a4c9b2ce7fd84a33c63bb82fdf88dcc17994a14ecbf0dd0be01d&quot;</span>
<span class="go">      }</span>
<span class="go">   ],</span>
<span class="go">   &quot;history&quot;: [</span>
<span class="go">...</span>
</pre></div>
</div>
<p>Также с помощью заголовка <code class="docutils literal notranslate"><span class="pre">Accept</span></code> можно выбрать версию манифеста:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>curl<span class="w"> </span>-v<span class="w"> </span>localhost:5000/v2/hello/manifests/0.1<span class="w"> </span>-H<span class="w"> </span><span class="s1">&#39;Accept: application/vnd.docker.distribution.manifest.v2+json&#39;</span>
<span class="go">*   Trying 127.0.0.1:5000...</span>
<span class="go">* Connected to localhost (127.0.0.1) port 5000 (#0)</span>
<span class="go">&gt; GET /v2/hello/manifests/0.1 HTTP/1.1</span>
<span class="go">&gt; Host: localhost:5000</span>
<span class="go">&gt; User-Agent: curl/7.88.1</span>
<span class="go">&gt; Accept: application/vnd.docker.distribution.manifest.v2+json</span>
<span class="go">&gt;</span>
<span class="go">&lt; HTTP/1.1 200 OK</span>
<span class="go">&lt; Content-Length: 527</span>
<span class="go">&lt; Content-Type: application/vnd.docker.distribution.manifest.v2+json</span>
<span class="go">&lt; Docker-Content-Digest: sha256:3f8d6a1d510560a70b02dcc9722501c15fc4a1a78e11333913b863017dde40d7</span>
<span class="go">&lt; Docker-Distribution-Api-Version: registry/2.0</span>
<span class="go">&lt; Etag: &quot;sha256:3f8d6a1d510560a70b02dcc9722501c15fc4a1a78e11333913b863017dde40d7&quot;</span>
<span class="go">&lt; X-Content-Type-Options: nosniff</span>
<span class="go">&lt;</span>
<span class="go">{</span>
<span class="go">   &quot;schemaVersion&quot;: 2,</span>
<span class="go">   &quot;mediaType&quot;: &quot;application/vnd.docker.distribution.manifest.v2+json&quot;,</span>
<span class="go">   &quot;config&quot;: {</span>
<span class="go">      &quot;mediaType&quot;: &quot;application/vnd.docker.container.image.v1+json&quot;,</span>
<span class="go">      &quot;size&quot;: 633,</span>
<span class="go">      &quot;digest&quot;: &quot;sha256:643d97e6291d22876100fff8e6edc90eccd8b045011cd8a4aa95524d8d5a711f&quot;</span>
<span class="go">   },</span>
<span class="go">   &quot;layers&quot;: [</span>
<span class="go">      {</span>
<span class="go">         &quot;mediaType&quot;: &quot;application/vnd.docker.image.rootfs.diff.tar.gzip&quot;,</span>
<span class="go">         &quot;size&quot;: 1113611,</span>
<span class="go">         &quot;digest&quot;: &quot;sha256:e00c2c33f044a4c9b2ce7fd84a33c63bb82fdf88dcc17994a14ecbf0dd0be01d&quot;</span>
<span class="go">      }</span>
<span class="go">   ]</span>
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Нижняя область">
        <a href="03_practice_docker.html" class="btn btn-neutral float-left" title="Docker" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Предыдущая</a>
        <a href="05_practice_docker_volume_network.html" class="btn btn-neutral float-right" title="Docker Volume/Network" accesskey="n" rel="next">Следующая <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Алексей Юдолевич.</p>
  </div>

  Собрано при помощи <a href="https://www.sphinx-doc.org/">Sphinx</a> с использованием
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">темы,</a>
    предоставленной <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>